<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–º–æ—è –ª—é–±–∏–º–∞—è –ë–∏–±–∞!</title>
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="https://img.icons8.com/dusk/64/000000/heart-with-arrow.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600;700&family=Nunito:wght@600;700;800;900&family=SF+Mono:wght@500&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --card-light: rgba(255, 255, 255, 0.75);
            --card-border-light: rgba(255, 255, 255, 0.6);
            --text-main-light: #1d1d1f;
            --text-sub-light: #424245;
            
            --card-dark: rgba(30, 30, 35, 0.9);
            --card-border-dark: rgba(255, 255, 255, 0.15);
            --text-main-dark: #f5f5f7;
            --text-sub-dark: #a0a0a5;

            --accent: #ff3b30;
            --accent-glow: rgba(255, 59, 48, 0.5);
            --holiday-color: #ff9500;
            
            --blur: blur(30px);
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --vh: 1vh;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f5f5f7;
            color: var(--text-main-light);
            min-height: calc(var(--vh, 1vh) * 100);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            background: transparent;
            user-select: none;
            transition: color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- DYNAMIC BACKGROUNDS --- */
        .bg-mesh {
            position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--vh, 1vh) * 100); 
            z-index: -2;
            opacity: 0; transition: opacity 0.8s ease-in-out;
            background-size: cover;
        }
        .bg-mesh.active { opacity: 1; }

        #bg-snow {
            background: radial-gradient(at 30% 0%, #dbeafe 0%, transparent 60%), 
                        radial-gradient(at 70% 0%, #bfdbfe 0%, transparent 60%),
                        #eff6ff;
        }
        #bg-spring {
            background: radial-gradient(at 10% 10%, #ffe4e6 0%, transparent 50%), 
                        radial-gradient(at 90% 0%, #fecdd3 0%, transparent 50%),
                        #fff1f2;
        }
        #bg-rain {
            background: radial-gradient(at 50% 0%, #94a3b8 0%, transparent 70%),
                        #cbd5e1;
        }

        body.dark-mode { color: var(--text-main-dark); }
        body.dark-mode #bg-snow { background: radial-gradient(circle at 50% -20%, #172a45 0%, #0a0a0a 80%); }
        body.dark-mode #bg-spring { background: radial-gradient(circle at 50% -20%, #3e1f26 0%, #0a0a0a 80%); }
        body.dark-mode #bg-rain { background: radial-gradient(circle at 50% -20%, #252b36 0%, #050505 80%); }

        #canvas-fx { position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--vh, 1vh) * 100); z-index: -1; pointer-events: none; }

        /* --- GARLAND --- */
        .garland-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px; z-index: 100;
            display: flex; justify-content: space-between; pointer-events: none;
            opacity: 0; transition: opacity 0.5s; padding: 0 20px;
        }
        .garland-wrap.active { opacity: 1; }
        .string-segment {
            flex: 1; position: relative; border-top: 1px solid rgba(80, 80, 80, 0.5);
            border-radius: 50%; height: 20px; margin-top: -8px;
            display: flex; justify-content: space-around; transform-origin: top center;
            animation: gentleSway 5s ease-in-out infinite alternate;
        }
        .dark-mode .string-segment { border-top-color: rgba(255,255,255,0.2); }
        .micro-led { width: 4px; height: 4px; border-radius: 50%; margin-top: -2px; background: #fff; position: relative; }
        .led-warm { background: #ffb347; box-shadow: 0 0 6px #ff9e2c; }
        .led-cool { background: #5bc0de; box-shadow: 0 0 6px #2a9fd6; }
        .led-pink { background: #ff69b4; box-shadow: 0 0 6px #ff1493; }
        .dark-mode .led-warm { background: #ffdfba; box-shadow: 0 0 15px #ffdfba; }
        .dark-mode .led-cool { background: #cceeff; box-shadow: 0 0 15px #cceeff; }
        .dark-mode .led-pink { background: #ffbbcc; box-shadow: 0 0 15px #ffbbcc; }
        @keyframes gentleSway { from { transform: rotate(-1deg) translateY(0); } to { transform: rotate(1deg) translateY(2px); } }

        /* --- CONTROLS --- */
        .control-dock {
            position: fixed; top: calc(15px + var(--safe-top)); left: 50%; transform: translateX(-50%);
            background: rgba(240, 240, 240, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 4px; border-radius: 100px; display: flex; gap: 6px; z-index: 200;
            border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .dark-mode .control-dock { background: rgba(40,40,40,0.6); border-color: rgba(255,255,255,0.1); }
        .dock-btn {
            width: 42px; height: 42px; border-radius: 50%; border: none; background: transparent;
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        .dock-btn.active { background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: scale(1.05); }
        .dark-mode .dock-btn.active { background: rgba(255,255,255,0.2); }
        .dock-btn:active { transform: scale(0.95); }
        .coin-badge {
            position: absolute; top: -5px; right: -5px; background: #FFD700; color: #000;
            font-size: 10px; font-weight: 800; padding: 2px 5px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); min-width: 15px;
        }

        /* --- LAYOUT --- */
        .app-layout {
            max-width: 500px; margin: 0 auto; padding: calc(90px + var(--safe-top)) 20px 100px;
            position: relative; z-index: 10;
        }
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        header { text-align: center; margin-bottom: 30px; }
        h1 {
            font-family: 'Caveat', cursive; font-size: 60px; margin: 0; line-height: 0.9;
            color: var(--text-main-light); text-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .dark-mode h1 { color: var(--text-main-dark); text-shadow: 0 2px 20px rgba(0,0,0,0.8); }
        .subtitle {
            font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
            color: var(--text-sub-light); margin-top: 10px;
        }
        .dark-mode .subtitle { color: var(--text-sub-dark); }

        /* --- GLASS PANEL --- */
        .glass-panel {
            background: var(--card-light); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--card-border-light); border-radius: 32px; padding: 24px; margin-bottom: 24px;
            box-shadow: var(--shadow); transition: background 0.3s, border-color 0.3s;
        }
        .dark-mode .glass-panel { background: var(--card-dark); border-color: var(--card-border-dark); box-shadow: 0 10px 40px rgba(0,0,0,0.4); }

        /* --- FLIGHT --- */
        .flight-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .city-code { font-size: 32px; font-weight: 900; line-height: 1; letter-spacing: -1px; }
        .city-name { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--text-sub-light); }
        .dark-mode .city-name { color: var(--text-sub-dark); }
        #flight-viz { width: 100%; height: 130px; position: relative; }
        .track-path { fill: none; stroke: var(--text-sub-light); stroke-width: 2; stroke-dasharray: 6 6; opacity: 0.3; }
        .active-path { fill: none; stroke: var(--accent); stroke-width: 3; stroke-linecap: round; filter: drop-shadow(0 0 8px var(--accent-glow)); }
        #plane-wrapper {
            position: absolute; top: 0; left: 0; width: 40px; height: 40px; will-change: transform; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
        }
        .plane-emoji { font-size: 38px; line-height: 1; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); transform: rotate(90deg); transition: transform 0.5s; }
        @keyframes barrelRoll { 0% { transform: rotate(90deg); } 100% { transform: rotate(450deg); } }
        .pct-pill {
            position: absolute; top: -30px; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
            padding: 5px 12px; border-radius: 12px; font-family: 'Roboto Mono', monospace; font-size: 12px;
            font-weight: 700; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .dark-mode .pct-pill { background: rgba(60,60,60,0.9); color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }

        /* TIMER & CALENDAR */
        .countdown {
            text-align: center; font-family: 'Roboto Mono', monospace; font-size: 32px; font-weight: 700;
            margin-top: 15px; color: var(--text-main-light); letter-spacing: -1px;
        }
        .dark-mode .countdown { color: var(--text-main-dark); }
        .timer-caption { text-align: center; font-size: 13px; color: var(--text-sub-light); margin-bottom: 5px; font-weight: 700; }
        .dark-mode .timer-caption { color: var(--text-sub-dark); }
        .dates-meta { display: flex; justify-content: space-between; font-size: 12px; font-weight: 800; color: var(--text-sub-light); opacity: 0.6; margin-top: 20px; }
        .dark-mode .dates-meta { color: var(--text-sub-dark); opacity: 0.8; }

        /* CALENDAR GRID */
        .month-title { font-size: 20px; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .week-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 8px; }
        .week-day { text-align: center; font-size: 11px; font-weight: 800; color: var(--text-sub-light); opacity: 0.5; }
        .dark-mode .week-day { color: var(--text-sub-dark); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-item {
            aspect-ratio: 1; border-radius: 14px; background: rgba(0,0,0,0.03);
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; font-weight: 800; color: var(--text-sub-light);
            position: relative; cursor: pointer; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .dark-mode .day-item { background: rgba(255,255,255,0.06); color: var(--text-main-dark); }
        .day-item.future { opacity: 0.3; cursor: default; }
        .day-item.today { background: transparent; border: 2px solid var(--accent); color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); z-index: 2; transform: scale(1.1); }
        .day-item.holiday { border: 1px solid var(--holiday-color); color: var(--holiday-color); }
        .day-item.opened { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 5px 15px var(--accent-glow); }
        .day-item.missed { background: transparent; border: 1px dashed var(--accent); color: var(--accent); }
        .day-item:active { transform: scale(0.92); }
        .mini-heart { position: absolute; bottom: 3px; right: 3px; font-size: 9px; color: rgba(255,255,255,0.9); animation: heartBeat 1.5s infinite; }
        @keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .holiday-icon { position: absolute; top: -6px; right: -6px; font-size: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); z-index: 3; }

        /* --- MODAL --- */
        .modal-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--vh, 1vh) * 100);
            background: rgba(0,0,0,0.6); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-layer.active { opacity: 1; pointer-events: all; }
        .letter-box {
            background: #fff; width: 100%; border-radius: 40px; padding: 32px; text-align: center;
            transform: scale(0.9) translateY(40px); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        }
        .dark-mode .letter-box { background: #1c1c1e; color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .modal-layer.active .letter-box { transform: scale(1) translateY(0); }
        .quote-text { font-family: 'Caveat', cursive; font-size: 34px; line-height: 1.3; margin: 24px 0; color: #1d1d1f; }
        .dark-mode .quote-text { color: #f5f5f7; }

        .action-btn {
            background: #1d1d1f; color: #fff; border: none; width: 100%; padding: 18px;
            border-radius: 24px; font-weight: 800; font-size: 16px; cursor: pointer; transition: transform 0.2s;
        }
        .dark-mode .action-btn { background: #fff; color: #000; }
        .action-btn:active { transform: scale(0.97); }

        /* --- TOAST --- */
        .toast-pill {
            position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translate(-50%, 150px);
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 14px 28px; border-radius: 50px; font-weight: 700; color: #000;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2); z-index: 3000;
            display: flex; align-items: center; gap: 10px; white-space: nowrap;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .toast-pill.visible { transform: translate(-50%, 0); }

        /* --- PET GAME STYLES --- */
        .pet-stage {
            height: 380px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: visible; border-radius: 24px; transition: all 0.5s;
        }
        .house-bg {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 0; opacity: 0.3; font-size: 150px; 
            display: flex; align-items: center; justify-content: center; pointer-events: none; transition: all 0.5s;
        }
        .rent-info-text {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            font-size: 12px; font-weight: 800; color: var(--text-sub-light); opacity: 0.9; z-index: 10;
            background: rgba(255,255,255,0.6); padding: 4px 12px; border-radius: 12px; backdrop-filter: blur(5px);
            display: none; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .dark-mode .rent-info-text { color: var(--text-sub-dark); background: rgba(0,0,0,0.6); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        .pet-blob {
            width: 140px; height: 130px; background: #fff; border-radius: 50% 50% 45% 45%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); position: relative; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; justify-content: center; animation: breathe 3s infinite ease-in-out;
            cursor: pointer; z-index: 2;
        }
        .pet-blob.sleeping { animation: breathe 6s infinite ease-in-out; opacity: 0.9; }
        .pet-blob.sad { filter: grayscale(0.5) contrast(0.9); animation: sadShake 3s infinite; }
        .pet-blob.sick { filter: hue-rotate(90deg) contrast(0.8); animation: sadShake 4s infinite; }
        .pet-blob.walking { animation: walk 4s infinite linear; }
        .pet-blob:active { transform: scale(0.9) translateY(5px); }
        .dark-mode .pet-blob { background: #f0f0f5; box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        
        .pet-face { font-size: 50px; position: relative; z-index: 20; pointer-events: none; }
        
        /* ACCESSORIES POSITIONING REWORKED V19 - Precise Layering */
        #pet-acc-root { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        }
        .acc-item { position: absolute; display: flex; justify-content: center; width: 100%; transition: all 0.3s; }

        /* Hats - Sit on top of head */
        .acc-head { top: -45px; font-size: 60px; z-index: 30; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        
        /* Eyes - Sit on face */
        .acc-eyes { top: 35px; font-size: 45px; z-index: 25; }
        
        /* Neck - Under face, over body */
        .acc-neck { top: 80px; font-size: 55px; z-index: 15; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); }
        
        /* Body - Main Outfit */
        .acc-body { bottom: -10px; font-size: 115px; z-index: 10; opacity: 1; }
        
        /* Back - Wings etc (Behind blob) */
        .acc-back { top: 10px; font-size: 100px; z-index: -1; opacity: 0.8; transform: scale(1.2); }

        .pet-zzz { position: absolute; top: -30px; right: -10px; font-size: 24px; font-weight: 800; color: var(--text-sub-light); opacity: 0; }
        .sleeping .pet-zzz { opacity: 1; animation: floatZ 2s infinite; }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03) translateY(-3px); } }
        @keyframes sadShake { 0%,100% {transform: rotate(0);} 25% {transform: rotate(-3deg);} 75% {transform: rotate(3deg);} }
        @keyframes walk { 0% { transform: translateX(0) scale(1) rotate(0); } 25% { transform: translateX(30px) scale(0.95) rotate(5deg); } 50% { transform: translateX(0) scale(1) rotate(0); } 75% { transform: translateX(-30px) scale(0.95) rotate(-5deg); } 100% { transform: translateX(0) scale(1) rotate(0); } }
        @keyframes floatZ { 0% { transform: translate(0,0); opacity:0; } 50% { opacity:1; } 100% { transform: translate(10px, -20px); opacity:0; } }

        .click-float {
            position: absolute; font-weight: 800; font-size: 20px; color: #FFD700; pointer-events: none; z-index: 100;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: floatUp 0.8s ease-out forwards;
            white-space: pre; text-align: center; line-height: 1.2;
        }
        @keyframes floatUp { to { transform: translateY(-70px); opacity: 0; } }
        
        .stat-bars { width: 100%; margin-top: 20px; display: flex; gap: 8px; justify-content: center; z-index: 5; position: relative; }
        .stat-col { display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1; }
        .stat-icon { font-size: 14px; }
        .stat-num { font-size: 10px; font-weight: 800; opacity: 0.6; font-family: 'SF Mono', monospace; margin-top: 2px; }
        
        .progress-bar { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; position: relative; }
        .dark-mode .progress-bar { background: rgba(255,255,255,0.15); }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease-out; display: block; }
        .progress-fill.danger { background: #ff3b30 !important; animation: pulse 0.5s infinite alternate; }

        .game-info { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; font-size: 12px; font-weight: 800; color: var(--text-sub-light); }
        .streak-fire { color: #FF9500; }

        .pet-thought {
            background: rgba(255,255,255,0.8); padding: 10px 15px; border-radius: 15px;
            position: absolute; top: 10px; font-size: 13px; font-weight: 800; color: #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(10px);
            transition: all 0.3s; pointer-events: none; white-space: nowrap; z-index: 10;
        }
        .pet-thought.show { opacity: 1; transform: translateY(-10px); }

        .exp-container { width: 100%; margin-top: 5px; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; }
        .exp-bar { width: 80%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .exp-fill { height: 100%; background: linear-gradient(90deg, #32ade6, #007aff); width: 0%; transition: width 0.3s; }
        .lvl-text { font-size: 10px; font-weight: 800; color: var(--text-sub-light); margin-top: 3px; }

        .buffs-row { display: flex; gap: 5px; justify-content: center; margin-bottom: 5px; min-height: 20px; }
        .buff-icon {
            font-size: 12px; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 10px;
            border: 1px solid var(--accent); color: var(--accent); font-weight: 700; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .shop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--vh, 1vh) * 100); z-index: 2500;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .shop-modal.active { display: flex; }
        .dark-mode .shop-modal .glass-panel { background: #1c1c1e; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        
        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .shop-tab { padding: 5px 10px; border-radius: 10px; background: rgba(0,0,0,0.05); font-size: 11px; font-weight: 700; white-space: nowrap; cursor: pointer; }
        .shop-tab.active { background: var(--accent); color: #fff; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .shop-item {
            background: rgba(0,0,0,0.05); padding: 10px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;
            border: 2px solid transparent; text-align: center;
        }
        .dark-mode .shop-item { background: rgba(255,255,255,0.1); color: #fff; }
        .shop-item.owned { border-color: var(--accent); opacity: 0.7; }
        .shop-item.selected { background: var(--accent); color: #fff; }
        .shop-price { font-size: 11px; font-weight: 800; color: var(--holiday-color); }
        .shop-desc { font-size: 9px; opacity: 0.7; line-height: 1.1; margin-bottom: 4px; }

        .sleep-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,10,0.6); z-index: 40; pointer-events: none;
            display: none; border-radius: 24px;
            align-items: center; justify-content: center; color: #fff; font-size: 20px; font-weight: 800;
        }
        .sleep-overlay.active { display: flex; }

        /* --- CASINO (REAL WHEEL) --- */
        #view-casino {
            position: fixed; top:0; left:0; width:100%; height: calc(var(--vh, 1vh) * 100); z-index: 2200;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom));
            box-sizing: border-box;
        }
        #view-casino.active { display: flex; }
        .roulette-table {
            background: #0f4d19; padding: 20px; border-radius: 20px; border: 5px solid #d4af37;
            width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center;
        }
        .wheel-container {
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid #d4af37;
            position: relative; overflow: hidden; margin: 20px 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(#2ecc71 0deg 24deg, #e74c3c 24deg 48deg, #333 48deg 72deg, #e74c3c 72deg 96deg, #333 96deg 120deg, #e74c3c 120deg 144deg, #333 144deg 168deg, #e74c3c 168deg 192deg, #333 192deg 216deg, #e74c3c 216deg 240deg, #333 240deg 264deg, #e74c3c 264deg 288deg, #333 288deg 312deg, #e74c3c 312deg 336deg, #333 336deg 360deg);
            transition: transform 3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .wheel-arrow {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-top: 20px solid #fff; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }
        .roulette-opts { display: flex; gap: 10px; justify-content: center; margin-top: 20px; width: 100%; }
        .r-btn { border: none; padding: 15px; border-radius: 10px; color: #fff; font-weight: 700; flex: 1; cursor: pointer; transition: transform 0.2s; }
        .r-btn:active { transform: scale(0.95); }
        .r-red { background: #d91e18; }
        .r-black { background: #111; border: 1px solid #444; }
        .r-green { background: #2ecc71; }
        .casino-input { padding: 10px; border-radius: 12px; border: none; width: 150px; text-align: center; font-size: 18px; font-weight: 700; margin-bottom: 20px; }

        .weather-badge {
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.7);
            padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 700; z-index: 20;
            display: flex; align-items: center; gap: 5px;
        }
        
        .real-clock { font-size: 14px; font-weight: 800; color: var(--text-sub-light); margin-bottom: 5px; opacity: 0.8; }

        /* --- TRADING GAME (REPLACES BASKETBALL) --- */
        #view-trading {
            position: fixed; top: 0; left: 0; width: 100%; height: calc(var(--vh, 1vh) * 100);
            background: #121212; z-index: 3000; display: none;
            flex-direction: column; align-items: center; padding-top: 30px; color: #fff;
        }
        #view-trading.active { display: flex; }
        .trading-card {
            background: #1e1e1e; width: 90%; max-width: 350px; padding: 20px;
            border-radius: 20px; border: 1px solid #333; display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; -webkit-overflow-scrolling: touch; max-height: 85vh; /* Scroll Fix */
        }
        .chart-container { width: 100%; height: 150px; background: #000; border-radius: 10px; position: relative; overflow: hidden; flex-shrink: 0; }
        .trade-stat { display: flex; justify-content: space-between; font-size: 14px; color: #aaa; font-weight: 700; }
        .trade-val { color: #fff; font-size: 18px; font-family: 'SF Mono', monospace; }
        .trade-btns { display: flex; gap: 10px; margin-top: 10px; }
        .t-btn { flex: 1; padding: 15px; border-radius: 12px; font-weight: 800; border: none; font-size: 14px; cursor: pointer; color: #fff; transition: transform 0.1s; }
        .t-btn:active { transform: scale(0.95); }
        .t-buy { background: #30d158; }
        .t-sell { background: #ff453a; }
        .t-depo { background: #0a84ff; font-size: 12px; padding: 10px; }
        .t-with { background: #ff9500; font-size: 12px; padding: 10px; }
        
        .close-trading {
             position: absolute; top: calc(12px + var(--safe-top)); right: 16px; background: #333; color: #fff; 
             width: 40px; height: 40px; border-radius: 50%; border: none; font-weight: 900;
             display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
        }
        
        .help-btn {
            position: absolute; top: calc(12px + var(--safe-top)); left: 16px; background: rgba(255,255,255,0.2); color: #fff;
            width: 40px; height: 40px; border-radius: 50%; border: none; font-weight: 900;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; z-index: 10;
        }
        
        .trade-help-box {
            background: #333; padding: 15px; border-radius: 12px; font-size: 12px; color: #ccc;
            display: none; border: 1px solid #555; position: absolute; top: 70px; left: 20px; right: 20px; z-index: 20;
        }
        .trade-help-box.visible { display: block; }
        .trend-icon { font-size: 20px; margin-left: 5px; }
        
        .bank-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 10px; }
        .bank-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .bank-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; font-weight: 700; text-align: center; }
        .max-btn { background: #333; color: #fff; border: 1px solid #555; padding: 0 10px; border-radius: 8px; font-size: 10px; font-weight: 800; cursor: pointer; }

    
        /* --- iPhone / Touch polish --- */
        html { height: 100%; }
        body { min-height: calc(var(--vh, 1vh) * 100); }
        .dock-btn, .action-btn, .shop-item, .r-btn, .t-btn, .pet-blob, .day-item {
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        input, button { font-family: inherit; }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
        }

        /* --- PET: richer stage & softer glass --- */
        .pet-stage {
            background: radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.75), rgba(255,255,255,0.25) 55%, rgba(255,255,255,0.10) 100%);
            border: 1px solid rgba(255,255,255,0.45);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
            isolation: isolate;
        }
        .dark-mode .pet-stage {
            background: radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.10), rgba(255,255,255,0.05) 55%, rgba(255,255,255,0.03) 100%);
            border-color: rgba(255,255,255,0.10);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
        }
        .pet-stage::after {
            content: "";
            position: absolute;
            bottom: 18px;
            left: 50%;
            width: min(260px, 70%);
            height: 30px;
            transform: translateX(-50%);
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.22), rgba(0,0,0,0) 70%);
            opacity: 0.22;
            filter: blur(2px);
            z-index: 1;
            pointer-events: none;
        }
        .house-bg { opacity: 0.22; filter: blur(0.2px); }

        .pet-blob {
            border: 1px solid rgba(255,255,255,0.75);
            background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.78) 40%, rgba(240,240,245,0.75) 100%);
            box-shadow: 0 18px 55px rgba(0,0,0,0.12);
        }
        .dark-mode .pet-blob {
            border-color: rgba(255,255,255,0.15);
            background: radial-gradient(circle at 30% 25%, rgba(250,250,255,0.95) 0%, rgba(230,230,245,0.85) 45%, rgba(210,210,230,0.80) 100%);
            box-shadow: 0 18px 55px rgba(0,0,0,0.55);
        }
        .pet-blob::before{
            content:"";
            position:absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(circle at 28% 20%, rgba(255,255,255,0.85), rgba(255,255,255,0) 55%);
            opacity: 0.9;
            pointer-events: none;
        }
        .pet-blob::after{
            content:"";
            position:absolute;
            inset: 10px 14px 18px 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 70%, rgba(0,0,0,0.12), rgba(0,0,0,0) 60%);
            opacity: 0.18;
            pointer-events: none;
        }
        .pet-face { transition: transform 0.15s ease; }
        .pet-face.bop { transform: scale(1.12); }
        .weather-badge {
            border: 1px solid rgba(255,255,255,0.55);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .dark-mode .weather-badge { background: rgba(0,0,0,0.35); border-color: rgba(255,255,255,0.12); }
        .pet-thought {
            border: 1px solid rgba(255,255,255,0.45);
        }
        .dark-mode .pet-thought { background: rgba(0,0,0,0.55); color: #fff; border-color: rgba(255,255,255,0.12); }

        /* Stronger, more readable buttons */
        .action-btn { box-shadow: 0 10px 25px rgba(0,0,0,0.12); }
        .action-btn:active { box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

        /* Make shop modal safer on notch devices */
        .shop-modal { padding: calc(16px + var(--safe-top)) 16px calc(16px + var(--safe-bottom)); box-sizing: border-box; }
        .shop-modal .glass-panel { max-height: calc(var(--vh, 1vh) * 100 - 32px); overflow: hidden; }
        .shop-grid { max-height: min(360px, calc(var(--vh, 1vh) * 100 - 260px)); }

        /* Trading / Casino safe areas */
        #view-casino .roulette-table { margin-top: 6px; }
        #view-trading {
            padding-top: calc(14px + var(--safe-top)) !important;
            padding-bottom: calc(14px + var(--safe-bottom)) !important;
            box-sizing: border-box;
            background: radial-gradient(circle at 15% -10%, rgba(10,132,255,0.28), transparent 45%),
                        radial-gradient(circle at 85% 0%, rgba(48,209,88,0.18), transparent 35%),
                        #0f0f10 !important;
        }

    

        /* =========================================================
           MODERN REDESIGN (v4)
           - iPhone-first, bottom tabs, top actions, cleaner glass
           ========================================================= */

        :root{
            --accent: #ff2d55;
            --accent-glow: rgba(255, 45, 85, 0.45);
            --holiday-color: #ff9f0a;

            --radius-xl: 30px;
            --radius-lg: 24px;
            --radius-md: 18px;

            --shadow-soft: 0 18px 60px rgba(0,0,0,0.12);
            --shadow-hard: 0 18px 60px rgba(0,0,0,0.18);
            --blur: blur(26px);
        }

        body{
            background:
                radial-gradient(1200px 800px at 20% 10%, rgba(255, 45, 85, 0.12), transparent 60%),
                radial-gradient(900px 700px at 90% 0%, rgba(10, 132, 255, 0.14), transparent 55%),
                radial-gradient(1000px 900px at 50% 110%, rgba(52, 199, 89, 0.10), transparent 55%),
                #f6f7fb;
        }

        body::before{
            content:"";
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -1;
            opacity: 0.035;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
        }

        body.dark-mode{
            background:
                radial-gradient(1200px 800px at 20% 10%, rgba(255, 45, 85, 0.18), transparent 60%),
                radial-gradient(900px 700px at 90% 0%, rgba(10, 132, 255, 0.20), transparent 55%),
                radial-gradient(1000px 900px at 50% 110%, rgba(52, 199, 89, 0.14), transparent 55%),
                #050507;
        }

        /* Layout paddings now account for top actions + bottom tabs */
        .app-layout{
            padding-top: calc(108px + var(--safe-top));
            padding-bottom: calc(120px + var(--safe-bottom));
        }

        header{
            margin-bottom: 18px;
        }
        h1{
            font-size: 56px;
            letter-spacing: -1px;
        }
        .subtitle{
            letter-spacing: 2.6px;
            opacity: 0.85;
        }

        /* Cleaner glass */
        .glass-panel{
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
        }
        .dark-mode .glass-panel{
            box-shadow: var(--shadow-hard);
        }

        /* Top action bar */
        .top-actions{
            position: fixed;
            top: calc(14px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 250;
            display: flex;
            gap: 10px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255,255,255,0.55);
            border: 1px solid rgba(255,255,255,0.55);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.10);
        }
        .dark-mode .top-actions{
            background: rgba(30,30,35,0.55);
            border-color: rgba(255,255,255,0.12);
            box-shadow: 0 10px 36px rgba(0,0,0,0.35);
        }
        .icon-btn{
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.65);
            color: #000;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .15s ease, background .2s ease;
        }
        .icon-btn:active{ transform: scale(0.95); }
        .dark-mode .icon-btn{
            background: rgba(255,255,255,0.14);
            color: #fff;
        }

        /* Bottom tab bar */
        .tabbar{
            position: fixed;
            left: 50%;
            bottom: calc(10px + var(--safe-bottom));
            transform: translateX(-50%);
            z-index: 260;
            display: flex;
            gap: 10px;
            width: min(520px, calc(100% - 24px));
            padding: 10px;
            border-radius: 26px;
            background: rgba(255,255,255,0.60);
            border: 1px solid rgba(255,255,255,0.55);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: 0 18px 60px rgba(0,0,0,0.12);
        }
        .dark-mode .tabbar{
            background: rgba(30,30,35,0.62);
            border-color: rgba(255,255,255,0.14);
            box-shadow: 0 18px 70px rgba(0,0,0,0.42);
        }
        .tab-btn{
            flex: 1;
            border: none;
            background: transparent;
            border-radius: 18px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: transform .15s ease, background .2s ease;
            position: relative;
        }
        .tab-btn:active{ transform: scale(0.98); }
        .tab-btn.active{
            background: rgba(255,255,255,0.72);
        }
        .dark-mode .tab-btn.active{
            background: rgba(255,255,255,0.12);
        }
        .tab-ico{ font-size: 20px; }
        .tab-label{
            font-size: 12px;
            font-weight: 900;
            letter-spacing: 0.4px;
            opacity: 0.85;
        }
        .coin-badge{
            position: absolute;
            top: 6px;
            right: 8px;
            transform: none;
        }

        /* Theme sheet */
        .sheet-overlay{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 4000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 16px;
        }
        .sheet-overlay.active{ display: flex; }
        .sheet{
            width: min(520px, 100%);
            border-radius: 28px;
            background: rgba(255,255,255,0.86);
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(22px);
            -webkit-backdrop-filter: blur(22px);
            box-shadow: 0 30px 100px rgba(0,0,0,0.30);
            padding: 14px 14px 12px;
            transform: translateY(20px);
            animation: sheetIn .22s ease forwards;
        }
        .dark-mode .sheet{
            background: rgba(28,28,30,0.90);
            border-color: rgba(255,255,255,0.14);
            color: #fff;
        }
        @keyframes sheetIn{ to { transform: translateY(0); } }
        .sheet-handle{
            width: 44px;
            height: 5px;
            border-radius: 999px;
            background: rgba(120,120,130,0.35);
            margin: 4px auto 10px;
        }
        .sheet-title{
            font-weight: 900;
            font-size: 16px;
            text-align: center;
            margin-bottom: 2px;
        }
        .sheet-subtitle{
            font-size: 12px;
            text-align: center;
            opacity: 0.7;
            margin-bottom: 12px;
        }
        .theme-grid{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .theme-option{
            border: none;
            border-radius: 18px;
            padding: 14px 10px;
            font-weight: 900;
            font-size: 13px;
            cursor: pointer;
            background: rgba(0,0,0,0.04);
        }
        .dark-mode .theme-option{ background: rgba(255,255,255,0.10); color:#fff; }
        .theme-option:active{ transform: scale(0.98); }

        .sheet-close{
            margin-top: 12px;
            width: 100%;
            border: none;
            border-radius: 18px;
            padding: 14px;
            font-weight: 900;
            cursor: pointer;
            background: rgba(0,0,0,0.88);
            color:#fff;
        }
        .dark-mode .sheet-close{
            background: rgba(255,255,255,0.92);
            color:#000;
        }
        .sheet-close:active{ transform: scale(0.99); }

        /* Mood + Daily quests */
        .mood-row{
            display:flex;
            justify-content: space-between;
            align-items:center;
            font-size: 12px;
            font-weight: 900;
            color: var(--text-sub-light);
            margin-top: 10px;
            opacity: 0.9;
        }
        .dark-mode .mood-row{ color: var(--text-sub-dark); }
        .mood-bonus{
            opacity: 0.9;
        }

        .daily-wrap{
            margin-top: 12px;
            border-radius: 22px;
            padding: 14px;
            background: rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dark-mode .daily-wrap{
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.10);
        }
        .daily-head{
            display:flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 10px;
        }
        .daily-title{
            font-weight: 900;
            font-size: 13px;
        }
        .daily-date{
            font-size: 11px;
            opacity: 0.65;
            font-weight: 800;
            font-family: 'SF Mono', monospace;
        }
        .daily-list{
            display:flex;
            flex-direction: column;
            gap: 8px;
        }
        .quest-row{
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 10px;
            border-radius: 16px;
            background: rgba(255,255,255,0.55);
            border: 1px solid rgba(255,255,255,0.55);
        }
        .dark-mode .quest-row{
            background: rgba(0,0,0,0.35);
            border-color: rgba(255,255,255,0.10);
        }
        .quest-left{
            display:flex;
            align-items:center;
            gap: 10px;
            min-width: 0;
        }
        .quest-ico{ font-size: 16px; }
        .quest-title{
            font-weight: 900;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quest-sub{
            font-size: 10px;
            font-weight: 800;
            opacity: 0.65;
            margin-top: 2px;
            font-family: 'SF Mono', monospace;
        }
        .quest-right{
            text-align:right;
            display:flex;
            flex-direction: column;
            gap: 2px;
        }
        .quest-reward{
            font-size: 11px;
            font-weight: 900;
            color: var(--holiday-color);
        }
        .quest-done{
            font-size: 12px;
            font-weight: 900;
            color: #30d158;
        }

        /* Trading qty */
        .trade-qty{
            display:flex;
            gap: 10px;
            align-items:center;
            justify-content:center;
            margin-top: 6px;
        }
        .qty-btn{
            width: 44px;
            height: 38px;
            border-radius: 12px;
            border: 1px solid #333;
            background: #000;
            color:#fff;
            font-weight: 900;
            cursor:pointer;
        }
        .qty-btn:active{ transform: scale(0.97); }
        .qty-pill{
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.14);
            font-family: 'SF Mono', monospace;
            font-weight: 900;
            font-size: 12px;
        }

        /* Casino quick bet */
        .casino-quick{
            display:flex;
            gap: 10px;
            justify-content:center;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .q-btn{
            border:none;
            border-radius: 12px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.16);
            color:#fff;
            font-weight: 900;
            cursor:pointer;
        }
        .q-btn:active{ transform: scale(0.97); }

        /* Slightly bigger day tap targets */
        .day-item{
            border-radius: 16px;
        }

        /* Pet blob: richer look */
        .pet-blob{
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.95), rgba(255,255,255,0.55) 55%, rgba(255,255,255,0.85));
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 20px 60px rgba(0,0,0,0.14);
        }
        .dark-mode .pet-blob{
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.92), rgba(240,240,245,0.75) 55%, rgba(255,255,255,0.92));
        }

</style>
</head>
<body>

    <!-- Dynamic Backgrounds -->
    <div id="bg-snow" class="bg-mesh"></div>
    <div id="bg-spring" class="bg-mesh"></div>
    <div id="bg-rain" class="bg-mesh"></div>
    <canvas id="canvas-fx"></canvas>

    <!-- Top actions -->
    <div class="top-actions" role="toolbar" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button class="icon-btn" onclick="toggleThemeSheet()" id="btn-theme" aria-label="–í—ã–±—Ä–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É">
            <span id="theme-ico">üé®</span>
        </button>
        <button class="icon-btn" onclick="toggleGarland()" id="btn-garland" aria-label="–ì–∏—Ä–ª—è–Ω–¥–∞">‚ú®</button>
        <button class="icon-btn" onclick="toggleDark()" id="btn-dark" aria-label="–¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º">üåó</button>
    </div>

    <!-- Bottom tab bar -->
    <nav class="tabbar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <button class="tab-btn active" onclick="setView('calendar')" id="btn-view-cal">
            <span class="tab-ico">üìÖ</span>
            <span class="tab-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </button>
        <button class="tab-btn" onclick="setView('pet')" id="btn-view-pet">
            <span class="tab-ico">üêæ</span>
            <span class="tab-label">–ò–≥—Ä–∞</span>
            <span class="coin-badge" id="coin-display">0</span>
        </button>
    </nav>

    <!-- Theme sheet -->
    <div class="sheet-overlay" id="theme-sheet" onclick="closeThemeSheet(event)" aria-hidden="true">
        <div class="sheet" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div class="sheet-title">üé® –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞</div>
            <div class="sheet-subtitle">–í—ã–±–µ—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∞–π—Ç–∞</div>

            <div class="theme-grid">
                <button class="theme-option" onclick="setMode('snow'); closeThemeSheet()">‚ùÑÔ∏è –ó–∏–º–∞</button>
                <button class="theme-option" onclick="setMode('spring'); closeThemeSheet()">üå∏ –í–µ—Å–Ω–∞</button>
                <button class="theme-option" onclick="setMode('rain'); closeThemeSheet()">üåßÔ∏è –î–æ–∂–¥—å</button>
            </div>

            <button class="sheet-close" onclick="closeThemeSheet()">–ì–æ—Ç–æ–≤–æ</button>
        </div>
    </div>

    <div class="garland-wrap" id="garland"></div>

    <div class="app-layout">
        <header>
            <h1 id="header-title">–ú–æ—è –ª—é–±–∏–º–∞—è –ë–∏–±–∞</h1>
            <div class="subtitle">–ë—É–±–∞ —Å—á–∏—Ç–∞–µ—Ç –¥–Ω–∏ –¥–æ –≤—Å—Ç—Ä–µ—á–∏</div>
        </header>

        <!-- VIEW: CALENDAR -->
        <div id="view-calendar" class="view-section active-view">
            <div class="glass-panel">
                <div class="flight-header">
                    <div><div class="city-code">UFA</div><div class="city-name">–£—Ñ–∞</div></div>
                    <div><div class="city-code">MOW</div><div class="city-name">–ú–æ—Å–∫–≤–∞</div></div>
                </div>
                <div id="flight-viz">
                    <svg width="100%" height="100%" style="overflow:visible;">
                        <path id="path-bg" class="track-path" d="" />
                        <path id="path-active" class="active-path" d="" />
                    </svg>
                    <div id="plane-wrapper" onclick="doBarrelRoll()">
                        <div class="pct-pill" id="rt-percent">0.00000%</div>
                        <div class="plane-emoji" id="plane-icon">‚úàÔ∏è</div>
                    </div>
                </div>
                <div class="countdown" id="timer">...</div>
                <div class="timer-caption">–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –Ω–∞—à–µ–≥–æ –æ—Ç–ø—É—Å–∫–∞</div>
                <div class="dates-meta"><span>11 –Ø–Ω–≤</span><span>8 –ú–∞—è</span></div>
            </div>
            <div id="calendar-root"></div>
        </div>

        <!-- VIEW: PET -->
        <div id="view-pet" class="view-section">
            <div class="glass-panel" style="min-height: 500px;">
                <div class="month-title">
                    üíñ –¢–≤–æ–π –õ—é–±–∏–º–∫–∞
                </div>
                <div class="real-clock" id="real-clock">...</div>

                <!-- EXP BAR -->
                <div class="exp-container">
                    <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
                    <div class="lvl-text" id="lvl-text">–£—Ä–æ–≤–µ–Ω—å 1</div>
                </div>

                <div class="game-info">
                    <span>–ö–ª–∏–∫: <span id="stat-click">1</span> üí∞</span>
                    <span>–ê–≤—Ç–æ: <span id="stat-auto">0</span> üí∞/—Å–µ–∫</span>
                </div>
                <div class="game-info">
                     <span>–°—Ç—Ä–∏–∫: <span class="streak-fire" id="stat-streak">0</span> üî•</span>
                     <span>–ë–∞–ª–∞–Ω—Å: <span style="color:#FFD700" id="stat-balance">0</span> üí∞</span>
                </div>
                
                
                <div class="mood-row">
                    <span>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: <span id="mood-label">üôÇ</span></span>
                    <span class="mood-bonus">–î–æ—Ö–æ–¥: <span id="mood-mult">x1.00</span></span>
                </div>

                <div class="daily-wrap">
                    <div class="daily-head">
                        <div class="daily-title">‚úÖ –ú–∏—Å—Å–∏–∏ –¥–Ω—è</div>
                        <div class="daily-date" id="daily-date">...</div>
                    </div>
                    <div class="daily-list" id="daily-quests"></div>
                </div>

<div class="pet-stage" id="pet-stage">
                    <div class="weather-badge" id="weather-badge">‚òÄÔ∏è –¢–µ–ø–ª–æ</div>
                    <div class="rent-info-text" id="rent-info">–ê—Ä–µ–Ω–¥–∞ –æ–ø–ª–∞—á–µ–Ω–∞</div>
                    <div class="house-bg" id="house-bg"></div>
                    <div class="pet-thought" id="pet-thought">–ü—Ä–∏–≤–µ—Ç!</div>
                    <div class="buffs-row" id="buffs-row"></div>
                    
                    <div class="sleep-overlay" id="sleep-overlay">
                        <div>
                           <div>–¢—Å—Å! –ü–∏—Ç–æ–º–µ—Ü —Å–ø–∏—Ç üò¥</div>
                           <div style="font-size:12px; opacity:0.7; margin-top:5px;">–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</div>
                        </div>
                    </div>

                    <div class="pet-blob" id="pet-blob" onpointerdown="petClick(event)" onclick="petClick(event)">
                        <div class="pet-zzz">Zzz...</div>
                        <!-- Accessories -->
                        <div id="pet-acc-root"></div>
                        <div class="pet-face" id="pet-face">üò∫</div>
                    </div>

                    <div class="stat-bars">
                        <div class="stat-col">
                            <span class="stat-icon">üçî</span>
                            <div class="progress-bar"><div class="progress-fill" id="bar-hunger" style="background:#ff9500; width:50%"></div></div>
                            <div class="stat-num" id="txt-hunger">50/100</div>
                        </div>
                        <div class="stat-col">
                            <span class="stat-icon">‚ù§Ô∏è</span>
                            <div class="progress-bar"><div class="progress-fill" id="bar-love" style="background:#ff2d55; width:50%"></div></div>
                            <div class="stat-num" id="txt-love">50/100</div>
                        </div>
                        <div class="stat-col">
                            <span class="stat-icon">‚ö°</span>
                            <div class="progress-bar"><div class="progress-fill" id="bar-energy" style="background:#32ade6; width:50%"></div></div>
                            <div class="stat-num" id="txt-energy">50/100</div>
                        </div>
                        <div class="stat-col">
                            <span class="stat-icon">üõÅ</span>
                            <div class="progress-bar"><div class="progress-fill" id="bar-hygiene" style="background:#5ac8fa; width:50%"></div></div>
                            <div class="stat-num" id="txt-hygiene">50/100</div>
                        </div>
                    </div>
                </div>

                <!-- Quick actions (UX) -->
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="background:#ff9f0a; color:#fff; flex:1; padding:12px;" onclick="openShop('food')">üçî –ü–æ–∫–æ—Ä–º–∏—Ç—å</button>
                    <button class="action-btn" style="background:#ff375f; color:#fff; flex:1; padding:12px;" onclick="giveHug()">ü§ó –û–±–Ω—è—Ç—å</button>
                    <button class="action-btn" style="background:#0a84ff; color:#fff; flex:1; padding:12px;" onclick="openShop('buff')">üíä –ê–ø—Ç–µ–∫–∞</button>
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="background:#28cd41; color:#fff; flex:1; padding:12px;" onclick="openTrading()">üìà –¢—Ä–µ–π–¥–∏–Ω–≥</button>
                    <button class="action-btn" style="background:#5ac8fa; color:#fff; flex:1; padding:12px;" onclick="washPet()">üõÅ –£–º—ã—Ç—å</button>
                    <button class="action-btn" style="background:#5856d6; color:#fff; flex:1; padding:12px;" id="btn-sleep" onclick="toggleSleep()">üò¥ –°–ø–∞—Ç—å</button>
                </div>

                <button class="action-btn" id="btn-rent" style="margin-top:10px; background:#ff3b30; display:none;" onclick="payRent()">üè† –û–ø–ª–∞—Ç–∏—Ç—å –ê—Ä–µ–Ω–¥—É</button>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="background:#32ade6; color:#fff; flex:1;" onclick="openCasino()">üé∞ –ö–∞–∑–∏–Ω–æ</button>
                    <button class="action-btn" style="background:var(--accent); color:#fff; flex:1;" onclick="openShop()">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading View (Improved) -->
    <div id="view-trading">
        <button class="close-trading" onclick="closeTrading()">X</button>
        <button class="help-btn" onclick="toggleTradeHelp()">?</button>
        
        <div class="trade-help-box" id="trade-help">
            <div style="font-weight:700; color:#fff; margin-bottom:5px;">–ü—Ä–∞–≤–∏–ª–∞</div>
            1. –¶–µ–Ω–∞ –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É.<br>
            2. –ö—Ä–∞—Å–Ω—ã–π = –î–µ—à–µ–≤–æ (–ü–æ–∫—É–ø–∞–π).<br>
            3. –ó–µ–ª–µ–Ω—ã–π = –î–æ—Ä–æ–≥–æ (–ü—Ä–æ–¥–∞–≤–∞–π).<br>
            4. –ë–∞–Ω–∫ –¥–∞–µ—Ç % —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.
        </div>

        <div class="month-title" style="margin-bottom:10px;">üìà –ë–∏—Ä–∂–∞ –õ—é–±–≤–∏</div>
        
        <div class="trading-card">
            <div style="display:flex; justify-content:space-between; align-items:center">
                 <div style="font-size:12px; font-weight:700; color:#aaa;">–¶–µ–Ω–∞ BibaCoin <span id="trend-arrow" class="trend-icon"></span></div>
                 <div class="trade-val" id="stock-price" style="color:#30d158">100.00</div>
            </div>
            
            <div class="chart-container">
                <canvas id="trade-chart" width="310" height="150"></canvas>
            </div>

            <div class="trade-stat">
                <span>–ü–æ—Ä—Ç—Ñ–µ–ª—å:</span>
                <span style="color:#fff"><span id="stock-owned">0</span> BC</span>
            </div>
            <div class="trade-stat">
                <span>–ú–æ–Ω–µ—Ç—ã:</span>
                <span style="color:#FFD700"><span id="trade-cash">0</span> üí∞</span>
            </div>

            <div class="trade-qty">
                <button class="qty-btn" onclick="tradeQtyStep(-1)">‚àí</button>
                <div class="qty-pill"><span id="trade-qty">1</span> BC</div>
                <button class="qty-btn" onclick="tradeQtyStep(1)">+</button>
            </div>

            <div class="trade-btns">
                <button class="t-btn t-buy" onclick="tradeBuy()">–ö—É–ø–∏—Ç—å</button>
                <button class="t-btn t-sell" onclick="tradeSell()">–ü—Ä–æ–¥–∞—Ç—å</button>
            </div>

            <div class="trade-stat">
                <span>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞:</span>
                <span class="trade-val" id="avg-entry">‚Äî</span>
            </div>
            <div class="trade-stat">
                <span>PnL:</span>
                <span class="trade-val" id="trade-pnl">0</span>
            </div>
<div class="bank-section">
                <div style="font-size:12px; font-weight:800; color:#aaa; margin-bottom:5px;">üè¶ –ë–∞–Ω–∫ (–°—Ç–∞–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è: <span id="bank-rate-disp" style="color:#0a84ff">5%</span>)</div>
                <div style="font-size:10px; color:#666; margin-bottom:10px;">–í –±–∞–Ω–∫–µ: <span id="bank-balance" style="color:#fff">0</span> üí∞</div>
                <div class="bank-row">
                    <input type="number" id="bank-amount" class="bank-input" placeholder="–°—É–º–º–∞">
                    <button class="max-btn" onclick="setMaxBank()">MAX</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="t-btn t-depo" onclick="bankDeposit()">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                    <button class="t-btn t-with" onclick="bankWithdraw()">–°–Ω—è—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Casino View -->
    <div id="view-casino">
        <div class="roulette-table">
            <div style="color:#fff; font-weight:800; font-size:24px; margin-bottom:10px;">üé∞ –†—É–ª–µ—Ç–∫–∞</div>
            <div style="color:#d4af37; margin-bottom:10px;">–ë–∞–ª–∞–Ω—Å: <span id="casino-balance">0</span></div>
            
            <div class="wheel-container">
                <div class="wheel-arrow"></div>
                <div class="wheel" id="roulette-wheel"></div>
            </div>

            <input type="number" id="casino-bet" class="casino-input" placeholder="–°—Ç–∞–≤–∫–∞" min="1">

            <div class="casino-quick">
                <button class="q-btn" onclick="setCasinoBet('min')">MIN</button>
                <button class="q-btn" onclick="setCasinoBet('half')">1/2</button>
                <button class="q-btn" onclick="setCasinoBet('max')">MAX</button>
            </div>
            
            <div class="roulette-opts">
                <button class="r-btn r-red" onclick="spinRoulette('red')">üî¥ x2</button>
                <button class="r-btn r-green" onclick="spinRoulette('green')">üü¢ x14</button>
                <button class="r-btn r-black" onclick="spinRoulette('black')">‚ö´ x2</button>
            </div>
        </div>
        <button class="action-btn" style="margin-top:20px; background:rgba(255,255,255,0.2); width:auto; padding:10px 30px;" onclick="document.getElementById('view-casino').classList.remove('active'); unlockScroll();">–í—ã—Ö–æ–¥</button>
    </div>

    <!-- Notification -->
    <div class="toast-pill" id="toast"><span>üîí</span> <span id="toast-text">...</span></div>

    <!-- Modal -->
    <div class="modal-layer" id="modal">
        <div class="letter-box">
            <div style="font-size: 50px; margin-bottom: 10px;">üíå</div>
            <div style="font-size: 11px; font-weight: 800; opacity: 0.4; text-transform: uppercase;" id="m-date">...</div>
            <div class="quote-text" id="m-text">...</div>
            <div style="font-weight: 700; color: var(--accent); margin-bottom: 30px;" id="m-source">...</div>
            <button class="action-btn" onclick="closeModal()">–õ—é–±–ª—é —Ç–µ–±—è, –ë—É–±–∞ ‚ù§Ô∏è</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div class="shop-modal" id="shop-modal">
        <div class="glass-panel" style="background: var(--card-light); width: 100%; max-width: 350px;">
            <div class="month-title">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω <span style="margin-left:auto; font-size:14px;">üí∞ <span id="shop-coins">0</span></span></div>
            <div style="font-size:10px; color:#666; margin-bottom:5px;">–ò–Ω—Ñ–ª—è—Ü–∏—è —Ü–µ–Ω (–£—Ä.<span id="inf-lvl">1</span>): +<span id="inf-pct">0</span>%</div>
            <div class="shop-tabs">
                <div class="shop-tab active" data-tab="food" onclick="switchShop('food', this)">üçî –ï–¥–∞</div>
                <div class="shop-tab" data-tab="wear" onclick="switchShop('wear', this)">üëó –û–¥–µ–∂–¥–∞</div>
                <div class="shop-tab" data-tab="house" onclick="switchShop('house', this)">üè† –ñ–∏–ª—å–µ</div>
                <div class="shop-tab" data-tab="gadget" onclick="switchShop('gadget', this)">ü§ñ –ì–∞–¥–∂–µ—Ç—ã</div>
                <div class="shop-tab" data-tab="buff" onclick="switchShop('buff', this)">üíä –ê–ø—Ç–µ–∫–∞</div>
                <div class="shop-tab" data-tab="upgrade" onclick="switchShop('upgrade', this)">‚ö° –ù–∞–≤—ã–∫–∏</div>
            </div>
            <div class="shop-grid" id="shop-list"></div>
            <button class="action-btn" style="margin-top:20px;" onclick="closeShop()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // === DATA ===
        const START = new Date(2026, 0, 11);
        const END = new Date(2026, 4, 8); // May 8th
        const DATA_KEY = 'love_cal_v3_final_r1';
        const SETTINGS_KEY = 'love_cal_settings_v3_r1';
        const PET_KEY = 'love_cal_pet_v21_balanced'; // New Key for migration to easier economy

        // iOS viewport height fix (address bar / PWA). Keeps full-screen modals stable.
        function setVhUnit() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setVhUnit);
        setVhUnit();

        const WEEKDAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        const HOLIDAYS = { '1-14': 'üíò', '1-23': '‚≠ê', '2-8': 'üå∑', '4-1': 'üéà', '4-9': 'üéñÔ∏è' };
        
        const quotes = [
            {t: "–ë–∏–±–∞, –º—ã —Å —Ç–æ–±–æ–π –∫–∞–∫ –ú–∞–∫–∫—É–∏–Ω –∏ –ú—ç—Ç—Ä ‚Äî –Ω–∞–≤—Å–µ–≥–¥–∞! –ö—á–∞—É!", s: "–¢–∞—á–∫–∏"},
            {t: "–£–ª—ã–±–∞–µ–º—Å—è –∏ –º–∞—à–µ–º, –ë–∏–±–∞! –°–∫–æ—Ä–æ —è –ø—Ä–∏–ª–µ—á—É –∏ –æ–±–Ω–∏–º—É —Ç–µ–±—è.", s: "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä"},
            {t: "–ß–µ–±—É—Ä–∞—à–∫–∞ –∏—Å–∫–∞–ª –¥—Ä—É–∑–µ–π, –∞ —è –Ω–∞—à–µ–ª —Ç–µ–±—è. –ò –º–Ω–µ –±–æ–ª—å—à–µ –Ω–∏–∫—Ç–æ –Ω–µ –Ω—É–∂–µ–Ω, –û–ª—è.", s: "–¢–≤–æ–π –ß–µ–±—É—Ä–∞—à–∫–∞"},
            {t: "–û–ª—è, –ø–æ—Å–ª–µ —Å—Ç–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π —Ä–∞–∑–ª—É–∫–∏? –í—Å–µ–≥–¥–∞.", s: "–°–µ–≤–µ—Ä—É—Å –°–Ω–µ–π–ø"},
            {t: "–ë–∏–±–∞, —Ç—ã ‚Äî –º–æ–π –¥–≤–∏–≥–∞—Ç–µ–ª—å V8. –ë–µ–∑ —Ç–µ–±—è —è –ø—Ä–æ—Å—Ç–æ —Ä–∂–∞–≤–∞—è –∂–µ–ª–µ–∑—è–∫–∞.", s: "–†–æ–º–∞–Ω—Ç–∏–∫–∞ –≥–∞—Ä–∞–∂–∞"},
            {t: "–Ø –ª—é–±–ª—é —Ç–µ–±—è, –ë–∏–±–∞. –î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å –∑–µ–±—Ä–æ–π –≤ –ø–æ–ª–æ—Å–∫—É.", s: "–ú–∞—Ä—Ç–∏"},
            {t: "–ú—ã —Å—Ç—Ä–æ–∏–ª–∏, —Å—Ç—Ä–æ–∏–ª–∏ –Ω–∞—à—É –ª—é–±–æ–≤—å –∏, –Ω–∞–∫–æ–Ω–µ—Ü, –ø–æ—Å—Ç—Ä–æ–∏–ª–∏!", s: "–ß–µ–±—É—Ä–∞—à–∫–∞"},
            {t: "–û–ª—è, —Ç—ã –≤–æ–ª—à–µ–±–Ω–∏—Ü–∞. –¢—ã –∑–∞–∫–æ–ª–¥–æ–≤–∞–ª–∞ –º–æ–µ —Å–µ—Ä–¥—Ü–µ –±–µ–∑ –≤—Å—è–∫–æ–π –ø–∞–ª–æ—á–∫–∏.", s: "–¢–≤–æ–π –≤–æ–ª—à–µ–±–Ω–∏–∫"},
            {t: "–°–∫–æ—Ä–æ—Å—Ç—å. –Ø —Å–∫–æ—Ä–æ—Å—Ç—å. –ù–æ –≤—Ä–µ–º—è –¥–æ 8 –º–∞—è —Ç—è–Ω–µ—Ç—Å—è –∫–∞–∫ —É–ª–∏—Ç–∫–∞!", s: "–ú–∞–∫–∫—É–∏–Ω"},
            {t: "–ë–∏–±–∞, —Ç—ã –º–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥. –ö–∞–∫ –®–∫–∏–ø–µ—Ä –¥–ª—è –†–∏–∫–æ.", s: "–ö–æ–º–∞–Ω–¥–∞"},
            {t: "–û–ª—è, —Ç—ã –∫—Ä–∞—Å–∏–≤–∞, –∫–∞–∫ –∑–∞–∫–∞—Ç –≤ –†–∞–¥–∏–∞—Ç–æ—Ä-–°–ø—Ä–∏–Ω–≥—Å.", s: "–ö—Ä–∞—Å–æ—Ç–∞"},
            {t: "–Ø –Ω–µ —Ö–æ—á—É –±—ã—Ç—å —á–µ–ª–æ–≤–µ–∫–æ–º, —è —Ö–æ—á—É –±—ã—Ç—å —Å —Ç–æ–±–æ–π, –ë–∏–±–∞!", s: "–ß–µ–±—É—Ä–∞—à–∫–∞"},
            {t: "–≠–∫—Å–ø–µ–∫—Ç–æ –ü–∞—Ç—Ä–æ–Ω—É–º! –ú–æ–µ —Å–∞–º–æ–µ —Å—á–∞—Å—Ç–ª–∏–≤–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Ç—ã.", s: "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä"},
            {t: "–ë–∏–±–∞, —Ç—ã ‚Äî –º–æ—è –∫–æ—Ä–æ–ª–µ–≤–∞ –î–∂—É–ª–∏–∞–Ω!", s: "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä"},
            {t: "–Ø —Å —Ç–æ–±–æ–π, –û–ª—è. –î–æ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ü–∞.", s: "–î–∞—Ä—ã –°–º–µ—Ä—Ç–∏"},
            {t: "–¢—ã ‚Äî –º–æ–π –∫—É–±–æ–∫ –ü–æ—Ä—à–Ω—è, –ë–∏–±–∞. –°–∞–º–∞—è –≥–ª–∞–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞.", s: "–ü–æ–±–µ–¥–∞"},
            {t: "–ì–µ–Ω–∞, –∞ –¥–∞–≤–∞–π —è –ø–æ–Ω–µ—Å—É —á–µ–º–æ–¥–∞–Ω—ã, –∞ —Ç—ã –ø–æ–Ω–µ—Å–µ—à—å –º–µ–Ω—è? –°–∫–æ—Ä–æ –ø–æ–Ω–µ—Å—É —Ç–µ–±—è –Ω–∞ —Ä—É–∫–∞—Ö!", s: "–ß–µ–±—É—Ä–∞—à–∫–∞"},
            {t: "–ë–∏–±–∞, —Ç—ã –¥–µ–ª–∞–µ—à—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π –º–∏—Ä —Ü–≤–µ—Ç–Ω—ã–º.", s: "–õ—é–±–æ–≤—å"},
            {t: "–¢—ã ‚Äî –º–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è, –û–ª—è. –ú–æ—è –ì–µ—Ä–º–∏–æ–Ω–∞.", s: "–£–º–Ω–∏—Ü–∞"},
            {t: "–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –±–µ–∑ —Ç–µ–±—è ‚Äî –∫–∞–∫ –ø–∏—Ç-—Å—Ç–æ–ø –¥–ª–∏–Ω–æ—é –≤ –≤–µ—á–Ω–æ—Å—Ç—å.", s: "–ì–æ–Ω–∫–∞"},
            {t: "–ë–∏–±–∞, —Ç—ã –≤–∫—É—Å–Ω–µ–µ, —á–µ–º –∞–ø–µ–ª—å—Å–∏–Ω—ã –¥–ª—è –ß–µ–±—É—Ä–∞—à–∫–∏.", s: "–°–ª–∞–¥–æ—Å—Ç—å"},
            {t: "–ü—Ä–æ—Å—Ç–æ —É–ª—ã–±–Ω–∏—Å—å, –û–ª—è. –¢–≤–æ—è —É–ª—ã–±–∫–∞ –æ—Å–≤–µ—â–∞–µ—Ç –º–Ω–µ –ø—É—Ç—å –¥–æ–º–æ–π.", s: "–°–≤–µ—Ç"},
            {t: "8 –º–∞—è ‚Äî —ç—Ç–æ –Ω–∞—à –¥–µ–Ω—å –ø–æ–±–µ–¥—ã –Ω–∞–¥ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º.", s: "–°–∫–æ—Ä–æ"},
            {t: "–Ø –ª—é–±–ª—é, –∫–∞–∫ —Ç—ã —Å–º–µ–µ—à—å—Å—è, –ë–∏–±–∞. –≠—Ç–æ –º—É–∑—ã–∫–∞ –¥–ª—è –º–æ–∏—Ö —É—à–µ–π.", s: "–ú—É–∑—ã–∫–∞"},
            {t: "–¢—ã ‚Äî –º–æ–π –¥–æ–º, –û–ª—è. –•–æ–≥–≤–∞—Ä—Ç—Å ‚Äî —ç—Ç–æ —Ç–∞–º, –≥–¥–µ —Ç—ã.", s: "–£—é—Ç"},
            {t: "–Ø —Å–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ, –∫–∞–∫ –ø–∏–Ω–≥–≤–∏–Ω—ã –ø–æ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–µ.", s: "–¢–æ—Å–∫–∞"},
            {t: "–ë–∏–±–∞, —Ç—ã –º–æ–π —à—Ç—É—Ä–º–∞–Ω –ø–æ –∂–∏–∑–Ω–∏.", s: "–ü—É—Ç—å"},
            {t: "–ú—ã —Å —Ç–æ–±–æ–π ‚Äî –∏–¥–µ–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞, –∫–∞–∫ –¢–∏–º–æ–Ω –∏ –ü—É–º–±–∞. –û–π, –Ω–µ—Ç, –∫–∞–∫ –ë–∏–±–∞ –∏ –ë—É–±–∞!", s: "–ò–¥–µ–∞–ª"},
            {t: "–û–ª—è, —Ç–≤–æ–∏ –≥–ª–∞–∑–∞ —Å–∏—è—é—Ç —è—Ä—á–µ, —á–µ–º —Ñ–∞—Ä—ã –ö—Å–µ–Ω–æ–Ω.", s: "–°–∏—è–Ω–∏–µ"},
            {t: "–Ø –ø—Ä–∏–ª–µ—á—É –∫ —Ç–µ–±–µ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –ú–æ–ª–Ω–∏—è –ú–∞–∫–∫—É–∏–Ω –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π.", s: "–û–±–µ—â–∞–Ω–∏–µ"},
            {t: "–¢—ã ‚Äî –º–æ–µ —á—É–¥–æ, –ë–∏–±–∞. –ú–æ–µ —É—à–∞—Å—Ç–æ–µ —á—É–¥–æ.", s: "–ù–µ–∂–Ω–æ—Å—Ç—å"},
            {t: "–¢–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ –∫–ª—è–Ω—É—Å—å, —á—Ç–æ –∑–∞–º—ã—à–ª—è—é —Ç–æ–ª—å–∫–æ —à–∞–ª–æ—Å—Ç—å... –∏ –ª—é–±–∏—Ç—å —Ç–µ–±—è!", s: "–ö–∞—Ä—Ç–∞ –ú–∞—Ä–æ–¥–µ—Ä–æ–≤"},
            {t: "–ë–∏–±–∞, —Ç—ã ‚Äî –º–æ–π —Å–ª–∞–¥–∫–∏–π —Å–∞—Ö–∞—Ä.", s: "–í–∫—É—Å"},
            {t: "–§–∏–∑–∏—á–µ—Å–∫–∏ —è –∑–¥–µ—Å—å, –Ω–æ –º—ã—Å–ª–µ–Ω–Ω–æ —è —É–∂–µ –æ–±–Ω–∏–º–∞—é —Ç–µ–±—è, –û–ª—è.", s: "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä"},
            {t: "–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è –ª—É—á—à–µ, –ë–∏–±–∞. –ö–∞–∫ –î–æ–∫ –•–∞–¥—Å–æ–Ω —É—á–∏–ª –ú–∞–∫–∫—É–∏–Ω–∞.", s: "–£—Ä–æ–∫"},
            {t: "–Ø –±–µ—Ä–µ–≥—É —Ç–µ–±—è –≤ —Å–µ—Ä–¥—Ü–µ, –∫–∞–∫ —Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ.", s: "–°–µ–π—Ñ"},
            {t: "–û–ª—è, —Ç—ã ‚Äî –º–æ—è –≤–µ—Å–Ω–∞. –¢—ã ‚Äî –º–æ–π –º–∞–π.", s: "–¢–µ–ø–ª–æ"},
            {t: "–ï—â–µ –Ω–µ–º–Ω–æ–≥–æ, –ë–∏–±–∞. –°–∫–æ—Ä–æ –º—ã –±—É–¥–µ–º –≤–º–µ—Å—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞.", s: "–í–µ—á–Ω–æ—Å—Ç—å"},
            {t: "–¢—ã ‚Äî –º–∞–≥–∏—è, –û–ª—è. –ß–∏—Å—Ç–∞—è –º–∞–≥–∏—è.", s: "–í–æ–ª—à–µ–±—Å—Ç–≤–æ"},
            {t: "–Ø –ª—é–±–ª—é —Ç–µ–±—è –¥–æ –õ—É–Ω—ã –∏ –æ–±—Ä–∞—Ç–Ω–æ, –º–æ—è –ë–∏–±–∞.", s: "–ö–æ—Å–º–æ—Å"},
            {t: "–¢—ã ‚Äî –º–æ–π –ª—É—á—à–∏–π –ø–æ–¥–∞—Ä–æ—á–µ–∫.", s: "–°—é—Ä–ø—Ä–∏–∑"},
            {t: "–ë–∏–±–∞, —è —Å–∫—É—á–∞—é –ø–æ —Ç–≤–æ–∏–º —Ç–µ–ø–ª—ã–º —Ä—É–∫–∞–º.", s: "–¢–∞–∫—Ç–∏–ª—å–Ω–æ—Å—Ç—å"},
            {t: "–¢—ã ‚Äî –ø—Ä–∏—á–∏–Ω–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —è –ø—Ä–æ—Å—ã–ø–∞—é—Å—å —Å —É–ª—ã–±–∫–æ–π.", s: "–£—Ç—Ä–æ"},
            {t: "–°–∫–æ—Ä–æ 8 –º–∞—è. –≠—Ç–æ—Ç –¥–µ–Ω—å –∏–∑–º–µ–Ω–∏—Ç –≤—Å–µ.", s: "–ù–∞–¥–µ–∂–¥–∞"},
            {t: "–Ø –≥–æ—Ç–æ–≤ –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ó–∞–ø—Ä–µ—Ç–Ω—ã–π –õ–µ—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–µ–±—è.", s: "–°–º–µ–ª–æ—Å—Ç—å"},
            {t: "–¢—ã ‚Äî –º–æ—è —Å–µ–º—å—è, –ë–∏–±–∞. –ê —Å–µ–º—å—é –Ω–µ –±—Ä–æ—Å–∞—é—Ç.", s: "–û—Ö–∞–Ω–∞"},
            {t: "–û–ª—è, —Ç—ã –ø–∞—Ö–Ω–µ—à—å —Å—á–∞—Å—Ç—å–µ–º.", s: "–ê—Ä–æ–º–∞—Ç"},
            {t: "–ú–æ–π –ø–∞—Ç—Ä–æ–Ω—É—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ä–º—É —Ç–µ–±—è, –ë–∏–±–∞.", s: "–ó–∞—â–∏—Ç–∞"},
            {t: "–Ø –ª—é–±–ª—é —Ç–µ–±—è, –∫–∞–∫ –ì–ª–æ—Ä–∏—è –ª—é–±–∏—Ç –ú–µ–ª–º–∞–Ω–∞ (—Ç–∞–π–Ω–æ, –Ω–æ —Å–∏–ª—å–Ω–æ!).", s: "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä"},
            {t: "–¢—ã ‚Äî –º–æ–π —Ñ–∏–Ω–∏—à, –û–ª—è. –ú–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å.", s: "–¶–µ–ª—å"},
            {t: "–ë–∏–±–∞, —Ç—ã —Å–∞–º–∞—è –∫—Ä–∞—Å–∏–≤–∞—è –¥–µ–≤–æ—á–∫–∞ –≤–æ –≤—Å–µ–ª–µ–Ω–Ω–æ–π.", s: "–§–∞–∫—Ç"},
            {t: "–Ø —Å—á–∏—Ç–∞—é —Å–µ–∫—É–Ω–¥—ã –¥–æ –Ω–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–∏.", s: "–í—Ä–µ–º—è"},
            {t: "–¢—ã ‚Äî –º–æ–µ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, –û–ª—è.", s: "–ú—É–∑–∞"},
            {t: "–ë–∏–±–∞ –∏ –ë—É–±–∞ ‚Äî —ç—Ç–æ –Ω–∞–≤—Å–µ–≥–¥–∞.", s: "–ê–∫—Å–∏–æ–º–∞"},
            {t: "–Ø –ª—é–±–ª—é —Ç–µ–±—è 3000.", s: "–ú—Å—Ç–∏—Ç–µ–ª–∏"},
            {t: "–¢—ã ‚Äî –º–æ–π –ª–∏—á–Ω—ã–π —Å–æ—Ä—Ç –≥–µ—Ä–æ–∏–Ω–∞, –û–ª—è.", s: "–°—É–º–µ—Ä–∫–∏ (–∫–ª–∞—Å—Å–∏–∫–∞)"},
            {t: "–°–∫–æ—Ä–æ –º—ã –±—É–¥–µ–º –ø–∏—Ç—å —á–∞–π –∏ —Å–º–æ—Ç—Ä–µ—Ç—å –º—É–ª—å—Ç–∏–∫–∏ –≤–º–µ—Å—Ç–µ.", s: "–ü–ª–∞–Ω—ã"},
            {t: "–ë–∏–±–∞, —Ç—ã ‚Äî –º–æ–π –∫–æ—Å–º–æ—Å.", s: "–í—Å–µ–ª–µ–Ω–Ω–∞—è"},
            {t: "–Ø –ª—é–±–ª—é –∫–∞–∂–¥—É—é —Ç–≤–æ—é —á–µ—Ä—Ç–æ—á–∫—É, –û–ª—è.", s: "–î–µ—Ç–∞–ª–∏"},
            {t: "8 –ú–ê–Ø! –ë–ò–ë–ê! –Ø –£–ñ–ï –õ–ï–ß–£!", s: "–ë–£–ë–ê"},
            {t: "–Ø –ø—Ä–∏–µ—Ö–∞–ª. –Ø –∑–¥–µ—Å—å. –Ø –ª—é–±–ª—é —Ç–µ–±—è.", s: "–§–ò–ù–ê–õ"}
        ];

        // MIGRATION LOGIC to keep progress but ease economy
        let state = {
            opened: JSON.parse(localStorage.getItem(DATA_KEY)) || {},
            settings: { mode: 'snow', garland: false, dark: false },
            pet: null
        };
        
        const savedPet = JSON.parse(localStorage.getItem(PET_KEY)) || JSON.parse(localStorage.getItem('love_cal_pet_v19_final'));
        
        if (savedPet) {
            state.pet = savedPet;
            if(state.pet.isSick === undefined) state.pet.isSick = false;
        } else {
            state.pet = {
                coins: 0, 
                clickLevel: 1, 
                autoLevel: 0,
                hunger: 80, love: 80, energy: 100, hygiene: 100,
                lastLogin: 0, streak: 0,
                wear: null, house: {id:'box', rent:0, ico:'üì¶', mult:1}, inventory: [],
                exp: 0, maxExp: 100, level: 1,
                activeBuffs: [], gadgets: { feeder: 0, sleeper: 0, heater: 0, ac: 0 },
                rentPaidMonth: -1, isSleeping: false, isSick: false,
                stocks: 0, stocksCost: 0, stockBank: 0, bankRate: 5,
                outfit: { head:null, eyes:null, neck:null, body:null, back:null },
                lastDecay: Date.now()
            };
        }

        if(state.pet.outfit === undefined) state.pet.outfit = { head:null, eyes:null, neck:null, body:null, back:null };
        if(state.pet.stocksCost === undefined) state.pet.stocksCost = 0;

        if(!state.pet.house.mult) state.pet.house.mult = 1;

        // === DAILY QUESTS (light, cozy progression) ===
        const dayKeyLocal = (d=new Date()) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2,'0');
            const da = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${da}`;
        };

        const DAILY_QUESTS = [
            { id:'feed', ico:'üçî', title:'–ü–æ–∫–æ—Ä–º–∏ –ª—é–±–∏–º–∫—É', goal: 1, rewardCoins: 80, rewardExp: 12, hint:'–ö—É–ø–∏ –ª—é–±—É—é –µ–¥—É' },
            { id:'wash', ico:'üßº', title:'–£—Å—Ç—Ä–æ–π –±–∞–Ω–Ω—ã–π –¥–µ–Ω—å', goal: 1, rewardCoins: 60, rewardExp: 10, hint:'–ù–∞–∂–º–∏ ¬´–ü–æ–º—ã—Ç—å¬ª' },
            { id:'hug',  ico:'ü§ó', title:'–û–±–Ω–∏–º–∏',          goal: 1, rewardCoins: 50, rewardExp: 10, hint:'–ù–∞–∂–º–∏ ¬´–û–±–Ω—è—Ç—å¬ª' },
            { id:'taps', ico:'‚ú®', title:'–ü–æ–∏–≥—Ä–∞–π (—Ç–∞–ø—ã)',   goal: 25, rewardCoins: 120, rewardExp: 18, hint:'–ü–æ—Ç–∞–ø–∞–π –ø–æ –ª—é–±–∏–º–∫–µ' }
        ];

        function ensureDailyQuests() {
            const key = dayKeyLocal();
            if(!state.pet.daily || state.pet.daily.date !== key) {
                state.pet.daily = {
                    date: key,
                    progress: { feed:0, wash:0, hug:0, taps:0 },
                    done: { feed:false, wash:false, hug:false, taps:false }
                };
            } else {
                // –º–∏–≥—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ –º–∏—Å—Å–∏–∏)
                state.pet.daily.progress = { feed:0, wash:0, hug:0, taps:0, ...(state.pet.daily.progress||{}) };
                state.pet.daily.done = { feed:false, wash:false, hug:false, taps:false, ...(state.pet.daily.done||{}) };
            }
            const dd = document.getElementById('daily-date');
            if(dd) dd.innerText = key;
        }

        function bumpQuest(id, amount=1) {
            ensureDailyQuests();
            if(!state.pet.daily.progress[id]) state.pet.daily.progress[id] = 0;
            if(state.pet.daily.done[id]) return;
            state.pet.daily.progress[id] += amount;

            const q = DAILY_QUESTS.find(x => x.id === id);
            if(!q) return;

            if(state.pet.daily.progress[id] >= q.goal && !state.pet.daily.done[id]) {
                state.pet.daily.done[id] = true;
                state.pet.coins += q.rewardCoins;
                addExp(q.rewardExp);
                showToast(`–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ ‚úÖ +${q.rewardCoins}üí∞`);
            }
        }

        function renderDailyQuests() {
            ensureDailyQuests();
            const root = document.getElementById('daily-quests');
            if(!root) return;

            root.innerHTML = DAILY_QUESTS.map(q => {
                const p = state.pet.daily.progress[q.id] || 0;
                const done = !!state.pet.daily.done[q.id];
                const prog = `${Math.min(p, q.goal)}/${q.goal}`;
                return `
                    <div class="quest-row">
                        <div class="quest-left">
                            <div class="quest-ico">${q.ico}</div>
                            <div class="quest-text">
                                <div class="quest-title">${q.title}</div>
                                <div class="quest-sub">${done ? '–ì–æ—Ç–æ–≤–æ' : (prog + ' ‚Ä¢ ' + q.hint)}</div>
                            </div>
                        </div>
                        <div class="quest-right">
                            ${done ? `<div class="quest-done">‚úÖ</div>` : `<div class="quest-reward">+${q.rewardCoins}üí∞</div>`}
                            ${done ? `` : `<div class="quest-sub">${prog}</div>`}
                        </div>
                    </div>
                `;
            }).join('');
        }



        // === ECONOMY FORMULAS (V22 - smoother early game, less exploits) ===
        // Inflation: gentle (2% per level). Applies only to consumables (food/buffs).
        const getInflationMultiplier = () => 1 + ((state.pet.level - 1) * 0.02);

        const clamp01 = (v) => Math.min(1, Math.max(0, v));

        const getMoodInfo = () => {
            const score = (state.pet.hunger + state.pet.love + state.pet.energy + state.pet.hygiene) / 4;

            // Sick overrides: auto stops, clicks weakened
            if(state.pet.isSick) {
                return { label: "–ë–æ–ª–µ–µ—Ç ü§í", multClick: 0.88, multAuto: 0 };
            }

            // Gentle bonuses (to avoid –ª–æ–º–∞—Ç—å –±–∞–ª–∞–Ω—Å)
            if(score >= 85) return { label: "–í –≤–æ—Å—Ç–æ—Ä–≥–µ üòª", multClick: 1.12, multAuto: 1.15 };
            if(score >= 70) return { label: "–°—á–∞—Å—Ç–ª–∏–≤ üò∫",  multClick: 1.06, multAuto: 1.06 };
            if(score >= 50) return { label: "–ù–æ—Ä–º üôÇ",      multClick: 1.00, multAuto: 1.00 };
            if(score >= 30) return { label: "–ì—Ä—É—Å—Ç–∏—Ç ü•∫",   multClick: 0.92, multAuto: 0.80 };
            return { label: "–ü–ª–æ—Ö–æ üòø", multClick: 0.85, multAuto: 0.60 };
        };



        // Click power: gives meaningful upgrades from level 2+, without exploding late game.
        // Uses CEIL and (level-1) exponent to avoid the "upgrade but still +1" problem.
        const getClickPowerForLevel = (lvl) => {
            const base = Math.max(1, Math.ceil(Math.pow(1.2, Math.max(0, lvl - 1))));

            // Small, readable bonuses (no crazy exponentials)
            const loveBonus     = 0.80 + (state.pet.love / 250);     // 0.80..1.20
            const hygieneBonus  = 0.85 + (state.pet.hygiene / 700);  // ~0.85..0.99
            const moodBonus     = getMoodInfo().multClick;           // ~0.85..1.12
            const streakBonus   = 1 + Math.min(0.12, state.pet.streak * 0.01);

            const final = base * loveBonus * hygieneBonus * moodBonus * streakBonus;
            return Math.max(1, Math.floor(final));
        };
        const getClickPower = () => getClickPowerForLevel(state.pet.clickLevel);

        // Auto income: starts paying earlier (lvl 2+), and scales with house comfort.
        const getAutoIncomeForLevel = (lvl) => {
            if(lvl <= 0) return 0;

            const base = Math.max(1, Math.ceil(Math.pow(1.15, Math.max(0, lvl - 1))));
            const houseMult = state.pet.house.mult || 1;

            // Mood affects auto stronger than click (but still gentle)
            const moodMult = getMoodInfo().multAuto; // sick => 0

            // When sleeping, auto is a bit slower (because we –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é)
            const sleepMult = state.pet.isSleeping ? 0.75 : 1.0;

            // Hunger gate: if very hungry, auto slows down
            const hungerGate = 0.60 + 0.40 * clamp01(state.pet.hunger / 100); // 0.60..1.00

            return Math.max(0, Math.floor(base * houseMult * moodMult * sleepMult * hungerGate));
        };
        const getAutoIncome = () => getAutoIncomeForLevel(state.pet.autoLevel);

        // Upgrade costs: tuned so first upgrades feel good, but still require effort.
        const getClickUpgradeCost = () => Math.floor(120 * Math.pow(1.55, Math.max(0, state.pet.clickLevel - 1)));
        const getAutoUpgradeCost  = () => Math.floor(250 * Math.pow(1.60, Math.max(0, state.pet.autoLevel)));

        // --- SHOP DATA ---
        const SHOP = {
            food: [
                {id:'f1',name:'–°—É—Ö–∞—Ä–∏–∫',ico:'üçû',cost:10,effect:'h+10'}, // Buffed basic food
                {id:'f2',name:'–ö–æ–Ω—Ñ–µ—Ç–∫–∞',ico:'üç¨',cost:20,effect:'h+15'},
                {id:'f3',name:'–Ø–±–ª–æ–∫–æ',ico:'üçé',cost:40,effect:'h+25'},
                {id:'f4',name:'–ë–∞–Ω–∞–Ω',ico:'üçå',cost:50,effect:'h+30'},
                {id:'f5',name:'–ü–æ–Ω—á–∏–∫',ico:'üç©',cost:100,effect:'h+40 l+5'},
                {id:'f6',name:'–ö—Ä—É–∞—Å—Å–∞–Ω',ico:'ü•ê',cost:150,effect:'h+50'},
                {id:'f7',name:'–ö–æ—Ñ–µ',ico:'‚òï',cost:200,effect:'e+40'},
                {id:'f8',name:'–ú–æ—Ä–æ–∂–µ–Ω–æ–µ',ico:'üç¶',cost:300,effect:'h+30 l+20'},
                {id:'f9',name:'–Ø–∏—á–Ω–∏—Ü–∞',ico:'üç≥',cost:500,effect:'h+70'},
                {id:'f10',name:'–ë—É—Ä–≥–µ—Ä',ico:'üçî',cost:800,effect:'h+100'},
                {id:'f11',name:'–ü–∏—Ü—Ü–∞',ico:'üçï',cost:1200,effect:'h+100 l+10'},
                {id:'f12',name:'–°—É—à–∏',ico:'üç£',cost:2500,effect:'h+80 l+40'},
                {id:'f13',name:'–†–∞–º–µ–Ω',ico:'üçú',cost:3000,effect:'h+100 e+20'},
                {id:'f14',name:'–°—Ç–µ–π–∫',ico:'ü•©',cost:5000,effect:'h+100 e+50'},
                {id:'f15',name:'–õ–æ–±—Å—Ç–µ—Ä',ico:'ü¶û',cost:10000,effect:'h+100 l+80'},
                {id:'f16',name:'–£—Å—Ç—Ä–∏—Ü—ã',ico:'ü¶™',cost:15000,effect:'h+100 l+100'},
                {id:'f17',name:'–ß–µ—Ä–Ω–∞—è –ò–∫—Ä–∞',ico:'üåë',cost:30000,effect:'h+100 l+100'},
                {id:'f18',name:'–¢—Ä—é—Ñ–µ–ª—å',ico:'üçÑ',cost:50000,effect:'h+100 e+100 l+100'},
                {id:'f19',name:'–ó–æ–ª–æ—Ç–æ–π –°—Ç–µ–π–∫',ico:'üìÄ',cost:100000,effect:'h+100 e+100 l+100'},
                {id:'f20',name:'–£–∂–∏–Ω —Å –ú–∞—Å–∫–æ–º',ico:'üöÄ',cost:500000,effect:'h+100 e+100 l+100 exp+500'}
            ],
            wear: [
                {id:'w1',name:'–ë–∞–Ω—Ç–∏–∫',ico:'üéÄ',cost:500,pos:'head'},
                {id:'w2',name:'–û—á–∫–∏',ico:'üëì',cost:1500,pos:'eyes'},
                {id:'w3',name:'–®–∞—Ä—Ñ',ico:'üß£',cost:2500,pos:'neck'},
                {id:'w4',name:'–ö–µ–ø–∫–∞',ico:'üß¢',cost:5000,pos:'head'},
                {id:'w5',name:'–§—É—Ç–±–æ–ª–∫–∞',ico:'üëï',cost:5000,pos:'body'},
                {id:'w6',name:'–¢–µ–º–Ω—ã–µ –û—á–∫–∏',ico:'üï∂Ô∏è',cost:8000,pos:'eyes'},
                {id:'w7',name:'–ë–∞–±–æ—á–∫–∞',ico:'üéÄ',cost:10000,pos:'neck'},
                {id:'w8',name:'–ü–ª–∞—Ç—å–µ',ico:'üëó',cost:25000,pos:'body'},
                {id:'w9',name:'–¶–∏–ª–∏–Ω–¥—Ä',ico:'üé©',cost:50000,pos:'head'},
                {id:'w10',name:'–ú–æ–Ω–æ–∫–ª—å',ico:'üßê',cost:75000,pos:'eyes'},
                {id:'w11',name:'–¶–µ–ø—å',ico:'‚õìÔ∏è',cost:100000,pos:'neck'},
                {id:'w12',name:'–°–º–æ–∫–∏–Ω–≥',ico:'ü§µ',cost:150000,pos:'body'},
                {id:'w13',name:'–ö–æ—Ä–æ–Ω–∞',ico:'üëë',cost:500000,pos:'head'},
                {id:'w14',name:'–ú–∞–Ω—Ç–∏—è',ico:'üßõ',cost:750000,pos:'back'},
                {id:'w15',name:'–ö—Ä—ã–ª—å—è –§–µ–∏',ico:'üßö',cost:1000000,pos:'back'},
                {id:'w16',name:'–†—é–∫–∑–∞–∫',ico:'üéí',cost:200000,pos:'back'},
                {id:'w17',name:'–ù–∞—É—à–Ω–∏–∫–∏',ico:'üéß',cost:300000,pos:'head'},
                {id:'w18',name:'–ú–∞—Å–∫–∞',ico:'üé≠',cost:400000,pos:'eyes'},
                {id:'w19',name:'–ê–ª–º–∞–∑',ico:'üíé',cost:2000000,pos:'neck'},
                {id:'w20',name:'–°–∫–∞—Ñ–∞–Ω–¥—Ä',ico:'üë®‚ÄçüöÄ',cost:5000000,pos:'body'},
                {id:'w21',name:'–®–ª—è–ø–∞ –ú–∞–≥–∞',ico:'üßô‚Äç‚ôÇÔ∏è',cost:10000000,pos:'head'},
                {id:'w22',name:'–ö–æ—Å—Ç—é–º –ñ–ß',ico:'ü¶æ',cost:10000000,pos:'body'}
            ],
            house: [
                {id:'h1',name:'–ö–æ—Ä–æ–±–∫–∞',ico:'üì¶',cost:0,rent:0,mult:1.0},
                {id:'h2',name:'–ö–æ–≤—Ä–∏–∫',ico:'üßò',cost:5000,rent:0,mult:1.02},
                {id:'h3',name:'–ü–∞–ª–∞—Ç–∫–∞',ico:'‚õ∫',cost:15000,rent:0,mult:1.05},
                {id:'h4',name:'–®–∞–ª–∞—à',ico:'ü™µ',cost:50000,rent:0,mult:1.08},
                {id:'h5',name:'–ö–æ–º–Ω–∞—Ç–∞',ico:'üö™',cost:100000,rent:1000,mult:1.15},
                {id:'h6',name:'–°—Ç—É–¥–∏—è',ico:'üè¢',cost:250000,rent:5000,mult:1.25},
                {id:'h7',name:'–ö–≤–∞—Ä—Ç–∏—Ä–∞',ico:'üåá',cost:500000,rent:15000,mult:1.4},
                {id:'h8',name:'–¢–∞—É–Ω—Ö–∞—É—Å',ico:'üèòÔ∏è',cost:1500000,rent:0,mult:1.6},
                {id:'h9',name:'–ö–æ—Ç—Ç–µ–¥–∂',ico:'üè°',cost:3000000,rent:0,mult:1.8},
                {id:'h10',name:'–í–∏–ª–ª–∞',ico:'‚õ≤',cost:10000000,rent:50000,mult:2.5},
                {id:'h11',name:'–ü–µ–Ω—Ç—Ö–∞—É—Å',ico:'üåÉ',cost:25000000,rent:0,mult:3.0},
                {id:'h12',name:'–ó–∞–º–æ–∫',ico:'üè∞',cost:50000000,rent:0,mult:3.5},
                {id:'h13',name:'–û–±–ª–∞—á–Ω—ã–π –ó–∞–º–æ–∫',ico:'‚òÅÔ∏è',cost:150000000,rent:0,mult:4.5},
                {id:'h14',name:'–ü–æ–¥–≤–æ–¥–Ω–∞—è –ë–∞–∑–∞',ico:'üêô',cost:250000000,rent:0,mult:4.8},
                {id:'h15',name:'–û—Å—Ç—Ä–æ–≤',ico:'üèùÔ∏è',cost:350000000,rent:0,mult:5.5},
                {id:'h16',name:'–ú–∞—Ä—Å',ico:'ü™ê',cost:1000000000,rent:0,mult:7.0}
            ],
            gadget: [
                {id:'feeder',name:'–ê–≤—Ç–æ-–ö–æ—Ä–º',ico:'ü•£',cost:50000,dur:7,desc:'–ï–¥–∞ 7–¥–Ω'},
                {id:'sleeper',name:'–ê–≤—Ç–æ-–°–æ–Ω',ico:'üõå',cost:50000,dur:7,desc:'–°–æ–Ω 7–¥–Ω'},
                {id:'heater',name:'–û–±–æ–≥—Ä–µ–≤–∞—Ç–µ–ª—å',ico:'üî•',cost:30000,dur:3,desc:'–¢–µ–ø–ª–æ 3–¥–Ω'},
                {id:'ac',name:'–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä',ico:'‚ùÑÔ∏è',cost:30000,dur:3,desc:'–•–æ–ª–æ–¥ 3–¥–Ω'}
            ],
            buff: [
                {id:'m_para', name:'–ü–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª', ico:'üíä', cost:50, type:'cure', desc:'–õ–µ—á–∏—Ç –±–æ–ª–µ–∑–Ω—å'},
                {id:'m_syrup', name:'–°–∏—Ä–æ–ø', ico:'üß™', cost:100, type:'cure', desc:'–û—Ç –∫–∞—à–ª—è'},
                {id:'m_vita', name:'–í–∏—Ç–∞–º–∏–Ω–∫–∏', ico:'üçä', cost:200, type:'prevent', dur:300, desc:'–ò–º–º—É–Ω–∏—Ç–µ—Ç (5–º–∏–Ω)'},
                {id:'p_energy',name:'–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫ XL',ico:'‚ö°',cost:1000,type:'instant',effect:'e+100',desc:'–ú–∞–∫—Å –≠–Ω–µ—Ä–≥–∏—è'},
                {id:'p_heal',name:'–ê–ø—Ç–µ—á–∫–∞',ico:'üíâ',cost:2000,type:'instant',effect:'h+100 l+50',desc:'–ó–¥–æ—Ä–æ–≤—å–µ'},
                {id:'p_love',name:'–î—É—Ö–∏',ico:'üß¥',cost:5000,type:'instant',effect:'l+100',desc:'–ú–∞–∫—Å –õ—é–±–æ–≤—å'},
                {id:'b_speed',name:'–ó–µ–ª—å–µ –°–∫–æ—Ä–æ—Å—Ç–∏',ico:'üß™',cost:10000,type:'buff',val:2.0,dur:120,desc:'x2 –î–æ—Ö–æ–¥ (2–º–∏–Ω)'},
                {id:'b_magnet',name:'–ú–∞–≥–Ω–∏—Ç –ú–æ–Ω–µ—Ç',ico:'üß≤',cost:50000,type:'buff',val:5.0,dur:300,desc:'x5 –î–æ—Ö–æ–¥ (5–º–∏–Ω)'},
                {id:'b_love',name:'–ó–µ–ª—å–µ –í–µ—á–Ω–æ–π –õ—é–±–≤–∏',ico:'üíñ',cost:200000,type:'buff',val:10.0,dur:600,desc:'x10 –î–æ—Ö–æ–¥ (10–º–∏–Ω)'}
            ]
        };

        const THOUGHTS = [
            "–õ—é–±–ª—é —Ç–µ–±—è!", "–¢—ã –º–æ—è –≤—Å–µ–ª–µ–Ω–Ω–∞—è", "–•–æ—á—É –Ω–∞ —Ä—É—á–∫–∏", "–ú—É—Ä-–º—É—Ä...", 
            "–°–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ", "–¢—ã —Å–∞–º–∞—è –∫—Ä–∞—Å–∏–≤–∞—è", "–ì–¥–µ –µ–¥–∞?", "–•–æ—á—É –≥—É–ª—è—Ç—å", 
            "–¢—ã –º–æ–µ —Å—á–∞—Å—Ç—å–µ", "–ñ–¥—É —Ç–µ–±—è!", "–¢—ã –≤–∫—É—Å–Ω–æ –ø–∞—Ö–Ω–µ—à—å", "–û–±–Ω–∏–º–∏ –º–µ–Ω—è",
            "–û–ª—è —Ç–æ–ø!", "–õ—é–±–ª—é –±–æ–ª—å—à–µ –ø–∏—Ü—Ü—ã", "–¢—ã - –∫–æ—Å–º–æ—Å", "–°–∫–æ—Ä–æ —É–≤–∏–¥–∏–º—Å—è!",
            "–Ø —Å—á–∞—Å—Ç–ª–∏–≤ —Å —Ç–æ–±–æ–π", "–£–ª—ã–±–Ω–∏—Å—å!", "–¢—ã –º–æ–π –∫–æ—Ç–∏–∫", "–ú—ã –∫–æ–º–∞–Ω–¥–∞!",
            "–û–ª—è, —Ç—ã –ª—É—á—à–∞—è!", "–•–æ—á—É –æ–±–Ω–∏–º–∞—à–∫–∏", "–¢—ã - –º–æ–µ —Å–æ–ª–Ω—Ü–µ", "–ë–∏–±–∞ + –ë—É–±–∞",
            "–í–º–µ—Å—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞", "–¢—ã —Ç–∞–∫–∞—è –º–∏–ª–∞—è", "–ú–æ—è –ø—Ä–∏–Ω—Ü–µ—Å—Å–∞", "–õ—é–±–æ–≤—å!",
            "–° —Ç–æ–±–æ–π —Ç–µ–ø–ª–æ", "–ú–æ–µ —Å–µ—Ä–¥–µ—á–∫–æ —Ç–≤–æ–µ"
        ];

        const SAD_THOUGHTS = [
            "–Ø –≥–æ–ª–æ–¥–Ω—ã–π...", "–ü–æ–∫–æ—Ä–º–∏ –º–µ–Ω—è...", "–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ", "–ñ–∏–≤–æ—Ç–∏–∫ —É—Ä—á–∏—Ç", "–¢—ã –º–µ–Ω—è –∑–∞–±—ã–ª–∞?", "–•–æ–ª–æ–¥–Ω–æ...", "–•–æ—á—É –∫—É—à–∞—Ç—å"
        ];
        
        const DOM = {
            mount: document.getElementById('calendar-root'), modal: document.getElementById('modal'),
            track: document.getElementById('path-bg'), active: document.getElementById('path-active'),
            plane: document.getElementById('plane-wrapper'), pct: document.getElementById('rt-percent'),
            toast: document.getElementById('toast'), garland: document.getElementById('garland'),
            body: document.body, coinDisp: document.getElementById('coin-display')
        };

        function init() {
            const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY));
            if(saved) state.settings = { ...state.settings, ...saved };
            else {
                // First open: follow system theme (iPhone friendly)
                try{
                    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) state.settings.dark = true;
                }catch(e){}
            }
            applySettings(); checkDaily(); checkCircadianRhythm(true); checkRentStatus(); 
            // Calculate Offline Decay
            const now = Date.now();
            if(state.pet.lastDecay) {
                const diff = now - state.pet.lastDecay;
                const hours = diff / (1000 * 3600);
                if(hours > 1) {
                    const drop = Math.min(30, Math.floor(hours * 2)); // Reduced decay: 2 per hour, max 30
                    if(!state.pet.isSleeping) state.pet.energy = Math.max(0, state.pet.energy - drop);
                    state.pet.hunger = Math.max(0, state.pet.hunger - drop);
                    state.pet.love = Math.max(0, state.pet.love - drop);
                    state.pet.hygiene = Math.max(0, state.pet.hygiene - Math.floor(drop/2));
                    showToast(`–Ø —Å–∫—É—á–∞–ª! (–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –Ω–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∑–∏–ª–∏—Å—å)`);
                }
            }
            state.pet.lastDecay = now;
            updatePetUI();
            
            setInterval(() => {
                const now = new Date();
                const d = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                const t = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute:'2-digit' });
                document.getElementById('real-clock').innerText = `${d} | ${t}`;
            }, 1000);

            const colors = ['led-warm', 'led-cool', 'led-pink'];
            for(let i=0; i<8; i++) {
                const seg = document.createElement('div'); seg.className = 'string-segment'; seg.style.animationDelay = `${i * 0.5}s`;
                for(let k=0; k<4; k++) {
                    const led = document.createElement('div'); led.className = `micro-led ${colors[(i+k)%3]}`;
                    led.style.top = `${Math.sin(k)*5 + 10}px`; led.style.animationDelay = `${Math.random()*2}s`;
                    seg.appendChild(led);
                }
                DOM.garland.appendChild(seg);
            }
            renderCal(); calcGraph(); window.addEventListener('resize', calcGraph);
            requestAnimationFrame(flightLoop); setInterval(tick, 1000); tick(); runParticles();
            
            setInterval(gameLoop, 1000); // 1s tick
            setInterval(petBehavior, 10000);
            setInterval(() => checkCircadianRhythm(false), 60000);
        }

        function applySettings() {
            const s = state.settings;

            // Background mode
            document.querySelectorAll('.bg-mesh').forEach(b => b.classList.remove('active'));
            const bg = document.getElementById(`bg-${s.mode}`);
            if(bg) bg.classList.add('active');

            // Dark & garland
            DOM.body.classList.toggle('dark-mode', !!s.dark);
            DOM.garland.classList.toggle('active', !!s.garland);

            // Update theme icon on the top button
            const themeIco = document.getElementById('theme-ico');
            if(themeIco) {
                themeIco.innerText = (s.mode === 'snow') ? '‚ùÑÔ∏è' : (s.mode === 'spring' ? 'üå∏' : 'üåßÔ∏è');
            }
        }

        // --- Theme Sheet (modern) ---
        window.toggleThemeSheet = () => {
            const el = document.getElementById('theme-sheet');
            if(!el) return;
            const isOpen = el.classList.toggle('active');
            el.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
            if(isOpen) lockScroll(); else unlockScroll();
        };

        window.closeThemeSheet = (ev) => {
            // If called from onclick with event, allow close on overlay tap
            const el = document.getElementById('theme-sheet');
            if(!el) return;
            el.classList.remove('active');
            el.setAttribute('aria-hidden', 'true');

            // If other overlays are open, keep scroll locked
            const otherOpen = document.querySelector('.modal.active') || document.getElementById('shop-modal')?.classList.contains('active') || document.getElementById('view-trading')?.classList.contains('active') || document.getElementById('view-casino')?.classList.contains('active');
            if(!otherOpen) unlockScroll();
        };
        function saveSettings() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings)); }
        function normalizeCoins(){ state.pet.coins = Math.max(0, Math.round(state.pet.coins || 0)); }

        // Throttled persistence (better for iPhone –±–∞—Ç–∞—Ä–µ–π–∫–∞ + –º–µ–Ω—å—à–µ –ª–∞–≥–æ–≤ –æ—Ç localStorage)
        let __petPersistTimer = null;
        let __lastPersist = 0;
        function persistPetNow(){
            try { localStorage.setItem(PET_KEY, JSON.stringify(state.pet)); } catch(e) {}
            __lastPersist = Date.now();
        }

        // savePet(force=true) ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ä–∞–∑—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
        function savePet(force=false) {
            normalizeCoins();
            updatePetUI();

            if(force) { persistPetNow(); return; }

            const now = Date.now();
            const minInterval = 5000; // –Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 5 —Å–µ–∫—É–Ω–¥
            if(now - __lastPersist >= minInterval) {
                persistPetNow();
            } else {
                clearTimeout(__petPersistTimer);
                __petPersistTimer = setTimeout(persistPetNow, minInterval - (now - __lastPersist));
            }
        }

        window.addEventListener('visibilitychange', () => { if(document.hidden) savePet(true); });
        window.addEventListener('pagehide', () => savePet(true));


        // --- Scroll lock for iPhone modals (prevents background scrolling) ---
        let __scrollLockY = 0;
        function lockScroll(){
            __scrollLockY = window.scrollY || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${__scrollLockY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
        }
        function unlockScroll(){
            const y = __scrollLockY || 0;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            window.scrollTo(0, y);
        }


        function checkDaily() {
            ensureDailyQuests();
            const today = new Date().toDateString();
            if(state.pet.lastLogin !== today) {
                // Generate Daily Bank Rate (1% - 7%) ‚Äî –º–µ–Ω—å—à–µ ¬´—Å–ª–æ–º–∞–Ω–Ω—ã—Ö¬ª –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                state.pet.bankRate = Math.floor(Math.random() * 7) + 1;

                // Bank Interest
                if(state.pet.stockBank > 0) {
                     const interest = Math.floor(state.pet.stockBank * (state.pet.bankRate / 100));
                     state.pet.stockBank += interest;
                     showToast(`–ë–∞–Ω–∫ (${state.pet.bankRate}%): +${interest} –º–æ–Ω–µ—Ç`);
                }

                const diff = (Date.now() - new Date(state.pet.lastLoginTime || Date.now()).getTime()) / (1000 * 3600 * 24);
                if(diff > 1) { // Missed day
                    state.pet.streak = 0; // Reset streak
                } else {
                    state.pet.streak++;
                }
                state.pet.lastLogin = today; state.pet.lastLoginTime = Date.now();
                state.pet.coins += 50 + (state.pet.streak * 10);
                savePet(); showToast(`–ù–æ–≤—ã–π –¥–µ–Ω—å! +${50 + (state.pet.streak * 10)} üí∞`);
            }
        }

        function checkCircadianRhythm(isInit) {
            const h = new Date().getHours();
            const now = Date.now();
            const hasSleeper = state.pet.gadgets.sleeper > now;
            if(h >= 23 || h < 7) {
                if(hasSleeper && !state.pet.isSleeping) state.pet.isSleeping = true;
            } else {
                if(hasSleeper && state.pet.isSleeping) state.pet.isSleeping = false;
            }
            savePet();
        }

        function checkRentStatus() {
            if(!state.pet.house || !state.pet.house.rent) { document.getElementById('btn-rent').style.display = 'none'; return; }
            const currentMonth = new Date().getMonth();
            if(state.pet.rentPaidMonth !== currentMonth) {
                document.getElementById('btn-rent').style.display = 'block';
                document.getElementById('btn-rent').innerText = `üè† –û–ø–ª–∞—Ç–∏—Ç—å: ${state.pet.house.rent}`;
            } else document.getElementById('btn-rent').style.display = 'none';
        }

        window.payRent = () => {
            if(state.pet.coins >= state.pet.house.rent) {
                state.pet.coins -= state.pet.house.rent; state.pet.rentPaidMonth = new Date().getMonth();
                showToast("–û–ø–ª–∞—á–µ–Ω–æ!"); savePet(); checkRentStatus();
            } else showToast("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
        }

        window.toggleSleep = () => { state.pet.isSleeping = !state.pet.isSleeping; savePet(); }
        window.washPet = () => { state.pet.hygiene=100; state.pet.energy = Math.max(0, state.pet.energy - 5); bumpQuest('wash', 1); addExp(5); savePet(); showToast("–ß–∏—Å—Ç–æ!"); }

        window.giveHug = () => {
            if(state.pet.isSleeping) { showToast("–¢—Å—Å... –æ–Ω–∞ —Å–ø–∏—Ç üò¥"); return; }
            if(state.pet.isSick) { showToast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ª–µ—á–∏ ü§í"); return; }
            state.pet.love = Math.min(100, state.pet.love + 8);
            state.pet.energy = Math.max(0, state.pet.energy - 2);
            bumpQuest('hug', 1);
            addExp(3);
            showThought("–û–±–Ω–∏–º–∞—à–∫–∏! üíñ");
            savePet();
        }

        // --- TRADING GAME ---
        let tradeInterval;
        let stockPrice = 100.00;
        let priceHistory = [];
        let tradeQty = 1;

        function updateTradeQtyUI(){
            const el = document.getElementById('trade-qty');
            if(el) el.innerText = tradeQty;
        }

        window.tradeQtyStep = (dir) => {
            tradeQty = Math.max(1, Math.min(25, tradeQty + (dir||0)));
            updateTradeQtyUI();
        };

        const tCanvas = document.getElementById('trade-chart');
        const tCtx = tCanvas.getContext('2d');

        function resizeTradeCanvas() {
            const container = tCanvas.parentElement;
            if(!container) return;
            const cssW = Math.max(260, Math.min(340, container.clientWidth));
            const cssH = 150;
            const dpr = window.devicePixelRatio || 1;
            tCanvas.style.width = cssW + 'px';
            tCanvas.style.height = cssH + 'px';
            tCanvas.width = Math.floor(cssW * dpr);
            tCanvas.height = Math.floor(cssH * dpr);
            tCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        window.addEventListener('resize', () => { if(document.getElementById('view-trading').classList.contains('active')) { resizeTradeCanvas(); drawChart(); }});

        window.openTrading = () => {
            lockScroll();
            document.getElementById('view-trading').classList.add('active');
            // Init price history
            priceHistory = [];
            tradeQty = 1; updateTradeQtyUI();
            for(let i=0; i<30; i++) priceHistory.push(100);
            stockPrice = 100;
            resizeTradeCanvas();
            updateTradeUI();
            drawChart();
            tradeInterval = setInterval(tradeTick, 1000);
        };
        window.closeTrading = () => {
            document.getElementById('view-trading').classList.remove('active');
            clearInterval(tradeInterval);
            unlockScroll();
        };
        
        window.toggleTradeHelp = () => {
            document.getElementById('trade-help').classList.toggle('visible');
        }

        function tradeTick() {
            // Random Walk
            const change = (Math.random() - 0.5) * 5; 
            stockPrice = Math.max(10, stockPrice + change);
            priceHistory.push(stockPrice);
            if(priceHistory.length > 30) priceHistory.shift();
            drawChart();
            document.getElementById('stock-price').innerText = stockPrice.toFixed(2);
            const isUp = change >= 0;
            document.getElementById('stock-price').style.color = isUp ? '#30d158' : '#ff453a';
            document.getElementById('trend-arrow').innerText = isUp ? '‚Üó' : '‚Üò';
            document.getElementById('trend-arrow').style.color = isUp ? '#30d158' : '#ff453a';
        }

        function drawChart() {
            // Canvas is scaled with DPR in resizeTradeCanvas()
            const w = tCanvas.clientWidth || 310;
            const h = 150;

            tCtx.clearRect(0,0,w,h);

            // Gradient Fill
            const isProfit = priceHistory[priceHistory.length-1] >= priceHistory[0];
            const color = isProfit ? '#30d158' : '#ff453a';

            // Subtle grid
            tCtx.globalAlpha = 0.25;
            tCtx.strokeStyle = '#ffffff';
            tCtx.lineWidth = 1;
            for(let i=1;i<5;i++){
                const y = (h/5)*i;
                tCtx.beginPath(); tCtx.moveTo(0,y); tCtx.lineTo(w,y); tCtx.stroke();
            }
            tCtx.globalAlpha = 1;

            const gradient = tCtx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, isProfit ? 'rgba(48, 209, 88, 0.22)' : 'rgba(255, 69, 58, 0.22)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            tCtx.beginPath();
            const step = w / (priceHistory.length - 1);
            const padTop = 10;
            const padBot = 18;

            const max = Math.max(...priceHistory) + 5;
            const min = Math.min(...priceHistory) - 5;

            priceHistory.forEach((p, i) => {
                const y = h - padBot - ((p - min) / (max - min) * (h - padTop - padBot));
                if(i===0) tCtx.moveTo(0, y);
                else tCtx.lineTo(i*step, y);
            });

            tCtx.strokeStyle = color;
            tCtx.lineWidth = 2;
            tCtx.lineJoin = 'round';
            tCtx.stroke();

            // Fill
            tCtx.lineTo(w, h);
            tCtx.lineTo(0, h);
            tCtx.fillStyle = gradient;
            tCtx.fill();
        }

        window.tradeBuy = () => {
            const qty = Math.max(1, tradeQty || 1);

            // Small fee to prevent infinite spam-profit
            const fee = Math.max(1, Math.floor(stockPrice * 0.01));
            const unit = Math.ceil(stockPrice);
            const unitCost = unit + fee;
            const total = unitCost * qty;

            if(state.pet.coins >= total) {
                state.pet.coins -= total;
                state.pet.stocks += qty;
                state.pet.stocksCost = (state.pet.stocksCost || 0) + (unitCost * qty);

                showToast(`–ö—É–ø–ª–µ–Ω–æ ${qty} BC (–∫–æ–º–∏—Å—Å–∏—è ${fee}√ó${qty})`);
                updateTradeUI();
                savePet();
            } else showToast("–ù–µ—Ç –º–æ–Ω–µ—Ç!");
        }

        window.tradeSell = () => {
            const qty = Math.max(1, tradeQty || 1);

            if(state.pet.stocks >= qty) {
                const fee = Math.max(1, Math.floor(stockPrice * 0.01));
                const unit = Math.floor(stockPrice);
                const unitIncome = Math.max(0, unit - fee);
                const totalIncome = unitIncome * qty;

                // Reduce cost basis using average method
                const avgEntry = (state.pet.stocks > 0) ? ((state.pet.stocksCost || 0) / state.pet.stocks) : 0;

                state.pet.coins += totalIncome;
                state.pet.stocks -= qty;
                state.pet.stocksCost = Math.max(0, (state.pet.stocksCost || 0) - (avgEntry * qty));

                showToast(`–ü—Ä–æ–¥–∞–Ω–æ ${qty} BC (–∫–æ–º–∏—Å—Å–∏—è ${fee}√ó${qty})`);
                updateTradeUI();
                savePet();
            } else showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç BC!");
        }

        window.setMaxBank = () => {
            document.getElementById('bank-amount').value = Math.floor(state.pet.coins);
        }

        window.bankDeposit = () => {
            const el = document.getElementById('bank-amount');
            const val = parseInt(el.value);
            if(!val || val <= 0) { showToast("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"); return; }
            
            if(state.pet.coins >= val) {
                state.pet.coins -= val;
                state.pet.stockBank += val;
                showToast(`–í–∫–ª–∞–¥: ${val} (–°—Ç–∞–≤–∫–∞ ${state.pet.bankRate}%)`);
                el.value = '';
                updateTradeUI();
                savePet();
            } else showToast("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
        }

        window.bankWithdraw = () => {
            const el = document.getElementById('bank-amount');
            const val = parseInt(el.value);
            // If empty, withdraw all
            if(!val) {
                if(state.pet.stockBank > 0) {
                    state.pet.coins += state.pet.stockBank;
                    state.pet.stockBank = 0;
                    showToast("–°–Ω—è—Ç–æ –≤—Å—ë!");
                    updateTradeUI();
                    savePet();
                } else showToast("–ë–∞–Ω–∫ –ø—É—Å—Ç!");
                return;
            }

            if(val > 0 && state.pet.stockBank >= val) {
                state.pet.stockBank -= val;
                state.pet.coins += val;
                showToast(`–°–Ω—è—Ç–æ: ${val}`);
                el.value = '';
                updateTradeUI();
                savePet();
            } else showToast("–ú–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤ –≤ –±–∞–Ω–∫–µ!");
        }

        function updateTradeUI() {
            document.getElementById('stock-owned').innerText = state.pet.stocks;
            document.getElementById('trade-cash').innerText = Math.floor(state.pet.coins);

            document.getElementById('bank-rate-disp').innerText = state.pet.bankRate + '%';
            document.getElementById('bank-balance').innerText = Math.floor(state.pet.stockBank);

            // Extra stats (avg + pnl)
            const avgEl = document.getElementById('avg-entry');
            if(avgEl) {
                avgEl.innerText = (state.pet.stocks > 0) ? ((state.pet.stocksCost || 0) / state.pet.stocks).toFixed(2) : '‚Äî';
            }

            const pnlEl = document.getElementById('trade-pnl');
            if(pnlEl) {
                const fee = Math.max(1, Math.floor(stockPrice * 0.01));
                const mark = Math.max(0, Math.floor(stockPrice) - fee);
                const pnl = (state.pet.stocks * mark) - (state.pet.stocksCost || 0);
                pnlEl.innerText = `${pnl >= 0 ? '+' : ''}${Math.floor(pnl)}üí∞`;
                pnlEl.style.color = (pnl >= 0) ? '#30d158' : '#ff453a';
            }

            updatePetUI();
        }

        // --- RELAXED LOOPS ---
        function gameLoop() {
            const now = Date.now();
            const income = getAutoIncome();
            
            // Logic: Passive income only if healthy (Hunger > 0)
            if(income > 0 && state.pet.hunger > 0 && state.pet.love > 0) {
                let mult = 1;
                state.pet.activeBuffs = state.pet.activeBuffs.filter(b=>b.end>now);
                state.pet.activeBuffs.forEach(b=>mult*=b.val);
                const finalInc = state.pet.isSleeping ? Math.floor(income * mult * 0.5) : Math.floor(income * mult);
                state.pet.coins += finalInc;
            }

            // Sleep Regen
            if(state.pet.isSleeping) {
                state.pet.energy = Math.min(100, state.pet.energy + 0.5); // Slow regen
            }
            
            // Sickness Mechanic (Very Rare)
            // Chance: 0.05% per second (roughly once every 33 minutes of ACTIVE play)
            if(!state.pet.isSick && Math.random() < 0.0005) {
                // Check for immunity buff
                const isImmune = state.pet.activeBuffs.some(b => b.id === 'm_vita');
                if(!isImmune) {
                    state.pet.isSick = true;
                    showToast("–û–π! –ü–∏—Ç–æ–º–µ—Ü –∑–∞–±–æ–ª–µ–ª ü§í –ù—É–∂–Ω–∞ –∞–ø—Ç–µ–∫–∞!");
                }
            }

            if(Math.random() < 0.0025) triggerRandomEvent();
            savePet();
        }

        function triggerRandomEvent() {
            const events = [
                {t: "–ù–∞—à–ª–∞ –º–æ–Ω–µ—Ç–∫—É! +50", c: 50},
                {t: "–ü–æ–π–º–∞–ª–∞ –±–∞–±–æ—á–∫—É! +20 Exp", x: 20},
                {t: "–•–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞! +10 ‚ù§Ô∏è", l: 10},
                {t: "–ü—Ç–∏—á–∫–∞ —Å–ø–µ–ª–∞! +10 ‚ö°", e: 10},
                {t: "–ù–∞—à–ª–∞ –∑–∞–Ω–∞—á–∫—É! +100", c: 100}
            ];
            const ev = events[Math.floor(Math.random()*events.length)];
            if(ev.c) state.pet.coins+=ev.c;
            if(ev.x) addExp(ev.x);
            if(ev.l) state.pet.love=Math.min(100, state.pet.love+ev.l);
            if(ev.e) state.pet.energy=Math.min(100, state.pet.energy+ev.e);
            showToast("‚ú® " + ev.t);
        }

        function addExp(a) {
            state.pet.exp+=a; 
            if(state.pet.exp>=state.pet.maxExp) { 
                state.pet.level++; state.pet.exp=0; 
                // Increased difficulty curve for levels to slow down inflation
                state.pet.maxExp=Math.floor(state.pet.maxExp * 1.8); 
                state.pet.energy=100; 
                // Increased reward
                state.pet.coins+=200*state.pet.level; 
                showToast("–£—Ä–æ–≤–µ–Ω—å UP! üéâ"); 
            }
        }
        function petBehavior() {
            if(state.pet.isSleeping) return;
            // Sad Thoughts Logic
            if(state.pet.isSick) {
                showThought("–ö—Ö–µ-–∫—Ö–µ... ü§í");
            } else if(state.pet.hunger < 30 || state.pet.love < 30) {
                 const t = SAD_THOUGHTS[Math.floor(Math.random()*SAD_THOUGHTS.length)];
                 showThought(t);
            } else if(Math.random()>0.7) {
                showThought();
            }
        }

        function updatePetUI() {
            DOM.coinDisp.innerText = Math.floor(state.pet.coins);
            document.getElementById('shop-coins').innerText = Math.floor(state.pet.coins);
            document.getElementById('stat-balance').innerText = Math.floor(state.pet.coins);
            document.getElementById('casino-balance').innerText = Math.floor(state.pet.coins);

            // Mood + daily quests
            const mood = getMoodInfo();
            const ml = document.getElementById('mood-label');
            const mm = document.getElementById('mood-mult');
            if(ml) ml.innerText = mood.label;
            if(mm) mm.innerText = `x${mood.multAuto.toFixed(2)}`;
            renderDailyQuests();

            // Weather badge: ties to selected mode + gadgets
            const w = document.getElementById('weather-badge');
            const nowT = Date.now();
            const hasHeater = state.pet.gadgets.heater > nowT;
            const hasAc = state.pet.gadgets.ac > nowT;
            if(hasHeater) w.innerText = 'üî• –¢–µ–ø–ª–æ';
            else if(hasAc) w.innerText = '‚ùÑÔ∏è –ü—Ä–æ—Ö–ª–∞–¥–Ω–æ';
            else {
                if(state.settings.mode === 'snow') w.innerText = '‚ùÑÔ∏è –°–Ω–µ–∂–æ–∫';
                else if(state.settings.mode === 'spring') w.innerText = 'üå∏ –í–µ—Å–Ω–∞';
                else if(state.settings.mode === 'rain') w.innerText = 'üåßÔ∏è –î–æ–∂–¥–∏–∫';
            }

            
            document.getElementById('stat-click').innerText = getClickPower();
            document.getElementById('stat-auto').innerText = getAutoIncome();

            const pBars = ['hunger','love','energy','hygiene'];
            pBars.forEach(k => {
                const el = document.getElementById(`bar-${k}`);
                const val = state.pet[k];
                el.style.width = val+'%';
                if(val < 30) el.classList.add('danger'); else el.classList.remove('danger');
                document.getElementById(`txt-${k}`).innerText = `${Math.floor(val)}/100`;
            });

            document.getElementById('lvl-text').innerText = `–£—Ä. ${state.pet.level}`;
            document.getElementById('exp-fill').style.width = (state.pet.exp/state.pet.maxExp*100)+'%';
            
            const rentEl = document.getElementById('rent-info');
            if(state.pet.house && state.pet.house.rent > 0) {
                rentEl.style.display = 'block';
                const months = ['–Ø–Ω–≤–∞—Ä—è','–§–µ–≤—Ä–∞–ª—è','–ú–∞—Ä—Ç–∞','–ê–ø—Ä–µ–ª—è','–ú–∞—è','–ò—é–Ω—è','–ò—é–ª—è','–ê–≤–≥—É—Å—Ç–∞','–°–µ–Ω—Ç—è–±—Ä—è','–û–∫—Ç—è–±—Ä—è','–ù–æ—è–±—Ä—è','–î–µ–∫–∞–±—Ä—è'];
                const curM = new Date().getMonth();
                if(state.pet.rentPaidMonth === curM) {
                    rentEl.innerText = `–ê—Ä–µ–Ω–¥–∞ –æ–ø–ª–∞—á–µ–Ω–∞ –¥–æ –∫–æ–Ω—Ü–∞: ${months[curM]} ‚úÖ`;
                } else {
                    rentEl.innerText = `–ù—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –∞—Ä–µ–Ω–¥—É: ${state.pet.house.rent} üí∞`;
                }
            } else {
                rentEl.style.display = 'none';
            }


            const buffsDiv = document.getElementById('buffs-row'); buffsDiv.innerHTML='';
            const now = Date.now();
            if(state.pet.gadgets.feeder > now) buffsDiv.innerHTML+='<div class="buff-icon">ü•£</div>';
            if(state.pet.gadgets.heater > now) buffsDiv.innerHTML+='<div class="buff-icon">üî•</div>';
            state.pet.activeBuffs.forEach(b => buffsDiv.innerHTML+=`<div class="buff-icon">${b.ico}</div>`);

            const blob = document.getElementById('pet-blob');
            const face = document.getElementById('pet-face');
            const accRoot = document.getElementById('pet-acc-root');
            accRoot.innerHTML = ''; 
            
            document.getElementById('sleep-overlay').classList.toggle('active', state.pet.isSleeping);
            blob.classList.toggle('sleeping', state.pet.isSleeping);
            blob.classList.toggle('sick', state.pet.isSick);
            
            // Sad Face Logic
            const isSad = (state.pet.hunger < 30 || state.pet.love < 30 || state.pet.hygiene < 30);
            blob.classList.toggle('sad', isSad && !state.pet.isSick);

            if(state.pet.isSleeping) { 
                face.innerText = 'üò¥'; document.getElementById('btn-sleep').innerText="‚òÄÔ∏è"; 
            } else if(state.pet.isSick) {
                face.innerText = 'ü§í';
                document.getElementById('btn-sleep').innerText="üò¥";
            } else if(isSad) {
                face.innerText = 'ü•∫'; // Crying/Begging face
                document.getElementById('btn-sleep').innerText="üò¥";
            } else { 
                document.getElementById('btn-sleep').innerText="üò¥"; 
                face.innerText = (state.pet.love>90?'üòª':'üò∫'); 
            }
            
            // Render OUTFIT (Multi-slot)
            if(!state.pet.isSleeping) {
                // Order doesn't strictly matter for absolute div, but we iterate
                Object.values(state.pet.outfit).forEach(item => {
                    if(item) {
                        const ac = document.createElement('div');
                        ac.className = `acc-item acc-${item.pos || 'body'}`;
                        ac.innerText = item.ico;
                        accRoot.appendChild(ac);
                    }
                });
            }

            document.getElementById('house-bg').innerText = (state.pet.house && state.pet.house.id!=='box') ? state.pet.house.ico : 'üì¶';
        }

        // --- BALANCED CLICK (EASY MODE V21) ---
        window.petClick = (e) => {
            if(state.pet.isSleeping) return;
            if(state.pet.isSick) { showToast("–ü–∏—Ç–æ–º–µ—Ü –±–æ–ª–µ–µ—Ç! –ù—É–∂–Ω–∞ –∞–ø—Ç–µ–∫–∞ üíä"); return; }

            // Check resources (Much lower thresholds)
            if(state.pet.energy <= 0 || state.pet.hunger <= 0) {
                showToast("–ü–∏—Ç–æ–º–µ—Ü —É—Å—Ç–∞–ª –∏–ª–∏ –≥–æ–ª–æ–¥–µ–Ω!");
                return;
            }

            const power = getClickPower();

            // Stats cost per click (gentle)
            state.pet.energy = Math.max(0, state.pet.energy - 0.1);
            state.pet.hunger = Math.max(0, state.pet.hunger - 0.05);
            state.pet.hygiene = Math.max(0, state.pet.hygiene - 0.05);
            state.pet.love = Math.min(100, state.pet.love + 0.1);

            // Tap feedback
            const face = document.getElementById('pet-face');
            face.classList.add('bop');
            setTimeout(() => face.classList.remove('bop'), 140);

            // Pointer coords (works for touch/pointer/mouse)
            const pt = (() => {
                if(e && e.touches && e.touches[0]) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
                if(e && e.changedTouches && e.changedTouches[0]) return {x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY};
                return {x: e.clientX || (window.innerWidth/2), y: e.clientY || (window.innerHeight/2)};
            })();

            const float = document.createElement('div'); 
            float.className='click-float';
            float.innerText = `+${power}`;
            float.style.left=(pt.x-10)+'px'; 
            float.style.top=(pt.y-40)+'px';
            document.body.appendChild(float); 
            setTimeout(()=>float.remove(),800);

            state.pet.coins += power; 
            bumpQuest('taps', 1);
            addExp(0.5);
            savePet();
        }
        function showThought(t) { 
            const el = document.getElementById('pet-thought'); el.innerText=t||THOUGHTS[Math.floor(Math.random()*THOUGHTS.length)];
            el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2000); 
        }

        // CASINO - REAL WHEEL LOGIC
        window.openCasino = () => { lockScroll(); document.getElementById('view-casino').classList.add('active'); };

        window.setCasinoBet = (mode) => {
            const el = document.getElementById('casino-bet');
            if(!el) return;
            const bal = Math.max(0, Math.floor(state.pet.coins));

            if(mode === 'min') el.value = 1;
            else if(mode === 'half') el.value = Math.max(1, Math.floor(bal / 2));
            else if(mode === 'max') el.value = Math.max(1, bal);
            else {
                const v = parseInt(mode);
                if(!isNaN(v)) el.value = Math.max(1, v);
            }
        };

        
        window.spinRoulette = (choice) => {
            if(window.__rouletteSpinning) return;
            const betInput = document.getElementById('casino-bet');
            const bet = parseInt(betInput.value);
            const wheel = document.getElementById('roulette-wheel');

            if(!bet || bet <= 0) { showToast("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É! ‚ö†Ô∏è"); return; }
            if(state.pet.coins < bet) { showToast("–ù–µ—Ç –º–æ–Ω–µ—Ç! üí∏"); return; }

            window.__rouletteSpinning = true;
            document.querySelectorAll('.roulette-opts .r-btn').forEach(b => b.disabled = true);

            state.pet.coins -= bet;
            savePet();
            updatePetUI();

            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            wheel.offsetHeight;

            const result = Math.floor(Math.random() * 15);
            const segSize = 360 / 15;
            const targetAngle = (result * segSize) + (segSize / 2);
            const spin = 1800 + (360 - targetAngle);

            wheel.style.transition = 'transform 3s cubic-bezier(0.1, 0.9, 0.2, 1)';
            wheel.style.transform = `rotate(${spin}deg)`;

            setTimeout(() => {
                let color = 'green';
                if(result === 0) color = 'green';
                else if(result % 2 !== 0) color = 'red';
                else color = 'black';

                if(choice === color) {
                    let win = 0;
                    if(color === 'green') win = bet * 14;
                    else win = bet * 2;
                    state.pet.coins += win;
                    showToast(`–ü–æ–±–µ–¥–∞! ${color.toUpperCase()}! +${win} üí∞`);
                } else {
                    showToast(`–í—ã–ø–∞–ª–æ ${color}. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ!`);
                }

                savePet();
                updatePetUI();

                window.__rouletteSpinning = false;
                document.querySelectorAll('.roulette-opts .r-btn').forEach(b => b.disabled = false);
            }, 3000);
        }

        // SHOP
        let curTab = 'food';
        window.openShop = (tab='food') => { lockScroll(); document.getElementById('shop-modal').classList.add('active'); switchShop(tab); };
        window.closeShop = () => { document.getElementById('shop-modal').classList.remove('active'); unlockScroll(); };
        window.switchShop = (t, tabEl) => {
            curTab = t; 
            document.querySelectorAll('.shop-tab').forEach(el => el.classList.remove('active'));
            // If called from HTML click we get the element; if called programmatically we find by data-tab
            const activeEl = tabEl || document.querySelector(`.shop-tab[data-tab="${t}"]`);
            if(activeEl) activeEl.classList.add('active');

            const infMult = getInflationMultiplier();
            document.getElementById('inf-lvl').innerText = state.pet.level;
            document.getElementById('inf-pct').innerText = Math.round((infMult-1)*100);

            const list = document.getElementById('shop-list'); list.innerHTML = '';

            let items = [];
            if(t === 'upgrade') {
                 items.push({
                     id:'click_up', 
                     name:`–ö–ª–∏–∫ –£—Ä.${state.pet.clickLevel}`, 
                     ico:'üí™', 
                     cost: getClickUpgradeCost(), 
                     type:'u_click', 
                     desc:`–°–∏–ª–∞: ${getClickPowerForLevel(state.pet.clickLevel)} ‚ûî ${getClickPowerForLevel(state.pet.clickLevel+1)}`
                 });
                 items.push({
                     id:'auto_up', 
                     name:`–ê–≤—Ç–æ –£—Ä.${state.pet.autoLevel}`, 
                     ico:'‚öôÔ∏è', 
                     cost: getAutoUpgradeCost(), 
                     type:'u_auto', 
                     desc:`–î–æ—Ö–æ–¥: ${getAutoIncomeForLevel(state.pet.autoLevel)} ‚ûî ${getAutoIncomeForLevel(state.pet.autoLevel+1)}/—Å–µ–∫`
                 });
            } else {
                items = SHOP[t];
            }

            items.forEach(i => {
                const el = document.createElement('div');
                const owned = state.pet.inventory.includes(i.id) || state.pet.inventory.includes('house_'+i.id);

                // INFLATION LOGIC: Price increases by 2% per level for consumables
                let finalCost = i.cost;
                if(t === 'food' || t === 'buff') {
                    finalCost = Math.floor(i.cost * infMult);
                }

                // Check if equipped in slot
                let equipped = false;
                if(t === 'wear') equipped = state.pet.outfit[i.pos] && state.pet.outfit[i.pos].id === i.id;
                else if(t === 'house') equipped = state.pet.house && state.pet.house.id === i.id;

                el.className = `shop-item ${owned && t!=='food' && t!=='buff' ? 'owned' : ''} ${equipped ? 'selected' : ''}`;

                let txt = finalCost + ' üí∞';

                if(t === 'wear') {
                    txt = equipped ? '–°–Ω—è—Ç—å' : (owned ? '–ù–∞–¥–µ—Ç—å' : txt);
                }

                if(t === 'house') {
                    if(equipped) {
                        txt = (i.rent && i.rent > 0) ? `–ê—Ä–µ–Ω–¥–∞: ${i.rent}/–º–µ—Å ‚úÖ` : '–ñ–∏–≤—É';
                    } else if(i.rent && i.rent > 0) {
                        txt = `–í—ä–µ–∑–¥: ${i.cost} ‚Ä¢ ${i.rent}/–º–µ—Å`;
                    } else {
                        txt = owned ? '–ü–µ—Ä–µ–µ—Ö–∞—Ç—å' : txt;
                    }
                }

                if(t === 'gadget') {
                    if(state.pet.gadgets[i.id] > Date.now()) txt = "–ê–∫—Ç–∏–≤–Ω–æ";
                    else txt = finalCost + ' üí∞';
                }

                if(t === 'upgrade') txt = `–£–ª—É—á—à–∏—Ç—å: ${i.cost} üí∞`;

                // Description
                let desc = i.desc || '';
                if(t === 'house') {
                    const comfort = i.mult ? `–ö–æ–º—Ñ–æ—Ä—Ç: +${Math.round((i.mult-1)*100)}% –∫ –î–æ—Ö–æ–¥—É` : '–ë–∞–∑–æ–≤—ã–π –∫–æ–º—Ñ–æ—Ä—Ç';
                    const rentLine = (i.rent && i.rent>0) ? ` ‚Ä¢ –ê—Ä–µ–Ω–¥–∞ ${i.rent}/–º–µ—Å` : '';
                    desc = comfort + rentLine;
                }

                el.innerHTML = `<div style="font-size:30px">${i.ico}</div>
                                <div style="font-size:12px;font-weight:700">${i.name}</div>
                                <div class="shop-desc">${desc}</div>
                                <div class="shop-price">${txt}</div>`;
                el.onclick = () => buyItem(i, t, finalCost);
                list.appendChild(el);
            });
        };

        function buyItem(i, t, realCost) {
            // MULTI SLOT LOGIC FOR WEAR
            if(t==='wear') {
                const slot = i.pos || 'body';
                // Toggle Off
                if(state.pet.outfit[slot] && state.pet.outfit[slot].id === i.id) {
                    state.pet.outfit[slot] = null;
                    savePet(); switchShop(t); updatePetUI();
                    return;
                }
                // Check Cost
                if(state.pet.coins < realCost && !state.pet.inventory.includes(i.id)) { showToast("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!"); return; }
                
                // Buy if needed
                if(!state.pet.inventory.includes(i.id)) { 
                    state.pet.coins -= realCost; 
                    state.pet.inventory.push(i.id); 
                }
                
                // Equip
                state.pet.outfit[slot] = i;
                showToast("–°—Ç–∏–ª—å!");
                savePet(); switchShop(t); updatePetUI();
                return;
            }

            if(t==='house' && state.pet.house && state.pet.house.id===i.id) return; 
            
            // Check funds (upgrade uses i.cost, others realCost)
            const c = (t==='upgrade') ? i.cost : realCost;

            if(state.pet.coins < c && !state.pet.inventory.includes(i.id) && !state.pet.inventory.includes('house_'+i.id)) { showToast("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!"); return; }

            if(t==='food') {
                bumpQuest('feed', 1);
                const parts = i.effect.split(' ');
                parts.forEach(p => {
                    const v = parseInt(p.split('+')[1]);
                    if(p.includes('h+')) state.pet.hunger = Math.min(100, state.pet.hunger+v);
                    if(p.includes('e+')) state.pet.energy = Math.min(100, state.pet.energy+v);
                    if(p.includes('l+')) state.pet.love = Math.min(100, state.pet.love+v);
                    if(p.includes('exp+')) addExp(v);
                });
                showToast("–í–∫—É—Å–Ω–æ!"); addExp(2); // Reduced XP from food
                state.pet.coins -= c;
            } else if (t==='house') {
                const hid = 'house_'+i.id;
                if(i.rent > 0) { 
                     state.pet.coins -= c; state.pet.house = i; state.pet.rentPaidMonth = new Date().getMonth(); showToast("–° –Ω–æ–≤–æ—Å–µ–ª—å–µ–º!");
                } else { 
                    if(!state.pet.inventory.includes(hid)) { state.pet.coins-=c; state.pet.inventory.push(hid); }
                    state.pet.house = i; showToast("–î–æ–º –º–∏–ª—ã–π –¥–æ–º!");
                }
                checkRentStatus();
            } else if (t==='gadget') {
                if(state.pet.gadgets[i.id]>Date.now()) return;
                state.pet.coins-=c; state.pet.gadgets[i.id] = Date.now() + (i.dur*86400000); showToast("–†–∞–±–æ—Ç–∞–µ—Ç!");
            } else if (t==='upgrade') {
                state.pet.coins-=c; 
                if(i.type==='u_click') state.pet.clickLevel++;
                if(i.type==='u_auto') state.pet.autoLevel++;
                showToast("–£–ª—É—á—à–µ–Ω–æ! üí™");
            } else if (t==='buff') {
                 state.pet.coins-=c;
                 if(i.type === 'cure') {
                     state.pet.isSick = false;
                     showToast("–í—ã–∑–¥–æ—Ä–æ–≤–µ–ª! ‚ù§Ô∏è");
                 } else if (i.type === 'prevent') {
                     state.pet.activeBuffs.push({id:i.id, val:0, end:Date.now()+(i.dur*1000), ico:i.ico});
                     showToast("–ó–∞—â–∏—Ç–∞ –æ—Ç –±–æ–ª–µ–∑–Ω–µ–π!");
                 } else if(i.type === 'instant') {
                     const parts = i.effect.split(' ');
                     parts.forEach(p => {
                        const v = parseInt(p.split('+')[1]);
                        if(p.includes('h+')) state.pet.hunger = Math.min(100, state.pet.hunger+v);
                        if(p.includes('e+')) state.pet.energy = Math.min(100, state.pet.energy+v);
                        if(p.includes('l+')) state.pet.love = Math.min(100, state.pet.love+v);
                     });
                     showToast("–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç! ‚ö°");
                 } else {
                     state.pet.activeBuffs.push({id:i.id, val:i.val, end:Date.now()+(i.dur*1000), ico:i.ico});
                     showToast("–ú–∞–≥–∏—è! ‚ú®");
                 }
            }
            savePet(); switchShop(t); updatePetUI();
        }

        window.setView = (v) => {
            document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active-view'));
            document.getElementById(`view-${v}`).classList.add('active-view');
            document.getElementById('btn-view-cal').classList.toggle('active', v==='calendar');
            document.getElementById('btn-view-pet').classList.toggle('active', v==='pet');
        }
        window.setMode = (m) => { state.settings.mode=m; applySettings(); saveSettings(); }
        window.toggleGarland = () => { state.settings.garland=!state.settings.garland; applySettings(); saveSettings(); }
        window.toggleDark = () => { state.settings.dark=!state.settings.dark; applySettings(); saveSettings(); }
        window.doBarrelRoll = () => {
            const icon = document.getElementById('plane-icon'); icon.style.animation = 'barrelRoll 1s ease-in-out';
            setTimeout(() => icon.style.animation = '', 1000); showToast("–í–∂—É—É—É—Ö! ‚úàÔ∏è");
        }
        function tick() {
            const rem = END - new Date();
            if(rem<=0) { document.getElementById('timer').innerText="–ú–´ –í–ú–ï–°–¢–ï!"; return; }
            const d = Math.floor(rem/86400000);
            const h = Math.floor((rem%86400000)/3600000);
            const m = Math.floor((rem%3600000)/60000);
            const s = Math.floor((rem%60000)/1000);
            document.getElementById('timer').innerText = `${d}–¥ ${("0"+h).slice(-2)}:${("0"+m).slice(-2)}:${("0"+s).slice(-2)}`;
        }
        function renderCal() { 
             DOM.mount.innerHTML = '';
            let ptr = new Date(START);
            const today = new Date(); today.setHours(0,0,0,0);
            while(ptr <= END) {
                const y = ptr.getFullYear(); const m = ptr.getMonth();
                const card = document.createElement('div'); card.className = 'glass-panel';
                const name = ptr.toLocaleString('ru', { month: 'long' });
                const ico = (m<=1 || m===11) ? '‚ùÑÔ∏è' : 'üå∏';
                card.innerHTML = `<div class="month-title">${ico} <span style="text-transform:capitalize">${name}</span></div>`;
                const wh = document.createElement('div'); wh.className = 'week-header';
                WEEKDAYS.forEach(wd => {
                    const el = document.createElement('div'); el.className = 'week-day'; el.innerText = wd;
                    wh.appendChild(el);
                });
                card.appendChild(wh);
                const grid = document.createElement('div'); grid.className = 'cal-grid';
                const f = new Date(y,m,1);
                let skip = f.getDay() - 1; if(skip===-1) skip=6;
                for(let i=0; i<skip; i++) grid.appendChild(document.createElement('div'));
                const days = new Date(y,m+1,0).getDate();
                for(let d=1; d<=days; d++) {
                    const date = new Date(y,m,d);
                    if(date < START && m===START.getMonth()) { grid.appendChild(document.createElement('div')); continue; }
                    if(date > END) break;
                    const k = date.toISOString().split('T')[0];
                    const fut = date > today;
                    const isT = date.getTime()===today.getTime();
                    const op = state.opened[k];
                    const holKey = `${m}-${d}`;
                    const el = document.createElement('div'); el.className = 'day-item';
                    el.innerText = d;
                    if(HOLIDAYS[holKey]) {
                        el.classList.add('holiday');
                        const hIco = document.createElement('div'); hIco.className = 'holiday-icon'; hIco.innerText = HOLIDAYS[holKey];
                        el.appendChild(hIco);
                    }
                    if(fut) {
                        el.classList.add('future');
                        el.onclick = () => { const dateStr = date.toLocaleString('ru', { day: 'numeric', month: 'long' }); showToast(`–ü–æ—Ç–µ—Ä–ø–∏, –ë–∏–±–∞! –û—Ç–∫—Ä—ã—Ç—å –º–æ–∂–Ω–æ ${dateStr}`); };
                    } else {
                        if(isT) el.classList.add('today');
                        if(op) { el.classList.add('opened'); addHeart(el); }
                        else if(!isT) el.classList.add('missed');
                        el.onclick = () => {
                            if(!state.opened[k]) { state.opened[k]=true; state.pet.coins += 50; savePet(); showToast("–ù–∞–π–¥–µ–Ω–æ: 50 –º–æ–Ω–µ—Ç! üí∞"); }
                            localStorage.setItem(DATA_KEY, JSON.stringify(state.opened));
                            el.classList.add('opened'); el.classList.remove('missed');
                            if(isT) el.classList.remove('today');
                            addHeart(el);
                            const diff = Math.floor((date - START)/(86400000));
                            openLetter(date.toLocaleString('ru', { day: 'numeric', month: 'long' }), quotes[diff % quotes.length]);
                        }
                    }
                    grid.appendChild(el);
                }
                card.appendChild(grid); DOM.mount.appendChild(card);
                ptr = new Date(y,m+1,1);
            }
        }
        function calcGraph() {
            const el = document.getElementById('flight-viz'); if(!el) return;
            const w = el.offsetWidth; const h = el.offsetHeight;
            const d = `M 20 ${h-30} Q ${w/2} -20 ${w-20} ${h-50}`;
            DOM.track.setAttribute('d', d); DOM.active.setAttribute('d', d);
            len = DOM.track.getTotalLength();
        }
        function flightLoop() { 
             const tot = END - START; const pass = new Date() - START;
            let p = pass / tot; if(p<0) p=0; if(p>1) p=1;
            if(DOM.active && DOM.track) {
                DOM.active.style.strokeDasharray = len; DOM.active.style.strokeDashoffset = len * (1 - p);
                const pt = DOM.track.getPointAtLength(len * p);
                const next = DOM.track.getPointAtLength(Math.min(len, len*p + 2));
                const ang = Math.atan2(next.y - pt.y, next.x - pt.x) * 180 / Math.PI;
                const hover = Math.sin(Date.now() / 800) * 3;
                DOM.plane.style.transform = `translate(${pt.x - 20}px, ${pt.y - 20 + hover}px) rotate(${ang}deg)`;
                DOM.pct.innerText = (p * 100).toFixed(5) + '%'; DOM.pct.style.transform = `rotate(${-ang}deg)`;
            }
            requestAnimationFrame(flightLoop);
        }
        function runParticles() { 
            const c = document.getElementById('canvas-fx'); const ctx = c.getContext('2d');
            const rsz = () => { c.width = window.innerWidth; c.height = window.innerHeight; };
            window.addEventListener('resize', rsz); rsz();
            let pts = []; for(let i=0; i<80; i++) pts.push({x: Math.random()*c.width, y: Math.random()*c.height, z: Math.random()*0.5 + 0.5, s: Math.random()*Math.PI*2, v: Math.random()*0.02});
            function anim() {
                ctx.clearRect(0,0,c.width,c.height); const m = state.settings.mode; const isDark = state.settings.dark;
                pts.forEach(p => {
                    p.y += p.z * (m==='rain' ? 12 : 1); p.x += Math.sin(p.y*0.003 + p.s)*0.5; p.s += p.v;
                    if(p.y > c.height) { p.y = -20; p.x = Math.random()*c.width; }
                    ctx.beginPath();
                    if(m === 'snow') {
                        const rad = p.z * 3; const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, rad);
                        grad.addColorStop(0, `rgba(255,255,255,${0.8*p.z})`); grad.addColorStop(1, `rgba(255,255,255,0)`);
                        ctx.fillStyle = grad; ctx.arc(p.x, p.y, rad, 0, Math.PI*2); ctx.fill();
                    } else if(m === 'spring') {
                        ctx.save(); ctx.translate(p.x, p.y); ctx.scale(Math.cos(p.s), 1); ctx.rotate(p.s * 0.5);
                        ctx.fillStyle = `rgba(255, 192, 203, ${p.z})`;
                        ctx.moveTo(0,0); ctx.bezierCurveTo(5, -5, 10, 0, 0, 10); ctx.bezierCurveTo(-10, 0, -5, -5, 0, 0); ctx.fill(); ctx.restore();
                    } else if(m === 'rain') {
                        const color = isDark ? `rgba(255,255,255,${0.3*p.z})` : `rgba(80, 100, 130, ${0.5*p.z})`;
                        ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - 1, p.y + 15*p.z); ctx.stroke();
                    }
                }); requestAnimationFrame(anim);
            } anim();
        }
        function openLetter(d, q) { document.getElementById('m-date').innerText = d; document.getElementById('m-text').innerText = q.t; document.getElementById('m-source').innerText = "‚Äî " + q.s; DOM.modal.classList.add('active'); }
        window.closeModal = () => DOM.modal.classList.remove('active');
        let tm;
        function showToast(t) { document.getElementById('toast-text').innerText = t; DOM.toast.classList.add('visible'); clearTimeout(tm); tm = setTimeout(()=>DOM.toast.classList.remove('visible'), 2500); }
        function addHeart(p) { if(p.querySelector('.mini-heart')) return; const h = document.createElement('span'); h.className = 'mini-heart'; h.innerText = '‚ù§'; p.appendChild(h); }

        init();
    </script>
</body>
</html>
